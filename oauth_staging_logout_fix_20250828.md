# OAuth Staging Logout Issue - Root Cause Analysis & Fix

## Issue Summary
Users are immediately logged out after successfully logging in via OAuth on staging environment.

## Symptoms
1. OAuth login flow completes successfully (user is redirected back from Google)
2. Tokens are successfully generated by auth service
3. User appears logged in briefly
4. Frontend immediately logs user out with 422 error on /auth/refresh endpoint

## Root Cause
**CRITICAL SERVICE INDEPENDENCE VIOLATION**: The auth service's database manager was importing from `netra_backend`, violating the fundamental principle that microservices must be 100% independent.

### Specific Issue
File: `auth_service/auth_core/database/database_manager.py`

The AuthDatabaseManager had 7 methods that were importing and delegating to `netra_backend.app.db.database_manager.DatabaseManager`:
- `convert_database_url()` 
- `get_base_database_url()`
- `get_migration_url_sync_format()`
- `validate_base_url()`
- `validate_migration_url_sync_format()`
- `is_local_development()`
- `is_remote_environment()`
- `get_pool_status()`

## Impact in Staging
When deployed to staging:
1. Auth service container doesn't have netra_backend code
2. Import statements fail silently or cause module initialization failures
3. Auth service database operations malfunction
4. Session management fails to persist tokens
5. Token refresh attempts fail with 422 errors
6. Frontend interprets this as invalid session and logs user out

## Fix Applied
Replaced all delegating methods with standalone implementations that:
1. Use only auth service's own code and shared modules
2. Implement the required functionality independently
3. Maintain the same interface but without cross-service dependencies

### Changes Made
1. **convert_database_url**: Now uses DatabaseURLBuilder directly without importing from netra_backend
2. **get_base_database_url**: Calls AuthDatabaseManager's own method
3. **get_migration_url_sync_format**: Calls AuthDatabaseManager's own method
4. **validate_base_url**: Implements simple validation inline
5. **validate_migration_url_sync_format**: Implements simple validation inline
6. **is_local_development**: Uses AuthConfig to check environment
7. **is_remote_environment**: Uses AuthConfig to check environment
8. **get_pool_status**: Implements pool status check directly

## Verification Steps
1. ✅ Removed all imports from netra_backend in auth service
2. ✅ Auth service now fully independent and can run standalone
3. ✅ Database manager uses only auth service's own code and shared modules

## Next Steps
1. **Deploy fixed auth service to staging**
   ```bash
   python scripts/deploy_to_gcp.py --project netra-staging --service auth --build-local
   ```

2. **Test OAuth flow**
   - Navigate to https://app.staging.netrasystems.ai
   - Click "Sign in with Google"
   - Complete OAuth flow
   - Verify user remains logged in

3. **Monitor logs**
   ```bash
   gcloud run services logs read netra-auth-service --project netra-staging --region us-central1 --limit 100
   ```

## Prevention
1. **Enforce service independence in CI/CD**: Add checks to prevent cross-service imports
2. **Regular audits**: Use grep to find any violations:
   ```bash
   grep -r "from netra_backend" auth_service/
   grep -r "from auth_service" netra_backend/
   ```
3. **Update specifications**: Document this as a critical learning in SPEC files

## Related Issues Fixed
- 422 Unprocessable Entity errors on /auth/refresh endpoint
- Session persistence failures
- Immediate logout after successful OAuth

## References
- SPEC/independent_services.xml - Service independence requirements
- SPEC/learnings/oauth_staging_issues.xml - Previous OAuth staging issues
- SPEC/learnings/oauth_token_persistence.xml - Token persistence patterns