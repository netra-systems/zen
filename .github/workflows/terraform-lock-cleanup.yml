name: Terraform Lock Cleanup

# Disabled - only smoke tests and staging workflows are active
# on:
#   workflow_dispatch:
#     inputs:
#       pr_number:
#         description: 'PR number to cleanup (leave empty to cleanup all stale locks)'
#         required: false
#         type: string
#       force:
#         description: 'Force remove locks even if recent'
#         required: false
#         type: boolean
#         default: false
#   schedule:
#     # Run every hour to clean up stale locks
#     - cron: '0 * * * *'

env:
  GCP_PROJECT_ID: netra-staging
  GCP_REGION: us-central1
  STALE_LOCK_MINUTES: 15  # Consider locks stale after 15 minutes for GitHub Actions
  # ACT compatibility flags
  ACT_DETECTED: 'false'  # Will be overridden by ACT when running locally
  ACT_DRY_RUN: 'true'  # Default value
  ACT_MOCK_GCP: 'true'  # Default value

jobs:
  cleanup-terraform-locks:
    name: Cleanup Terraform Locks
    runs-on: warp-custom-default
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ACT Detection and Setup
        run: |
          echo "=== ACT Compatibility Check ==="
          if [[ "${{ env.ACT_DETECTED }}" == "true" ]]; then
            echo "🧪 Running in ACT (local) mode"
            echo "- Mock mode: ${{ env.ACT_MOCK_GCP }}"
            echo "- Dry run: ${{ env.ACT_DRY_RUN }}"
            echo "ACT_MODE=true" >> $GITHUB_ENV
          else
            echo "☁️ Running in GitHub Actions (cloud) mode"
            echo "ACT_MODE=false" >> $GITHUB_ENV
          fi

      - name: Authenticate to Google Cloud
        if: env.ACT_MODE != 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_STAGING_SA_KEY }}

      - name: Set up Cloud SDK
        if: env.ACT_MODE != 'true'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Setup Mock GCP Environment (ACT)
        if: env.ACT_MODE == 'true'
        run: |
          echo "🧪 Setting up mock GCP environment for ACT"
          # Create mock gsutil command
          mkdir -p ~/bin
          cat > ~/bin/gsutil << 'EOF'
          #!/bin/bash
          echo "[ACT-MOCK] gsutil $@"
          case "$1" in
            "stat")
              echo "[ACT-MOCK] Mock file stats for: $2"
              echo "Creation time: $(date)"
              ;;
            "cat")
              echo "[ACT-MOCK] Mock lock content: {\"ID\":\"test-123\",\"Who\":\"runner@act\",\"Created\":\"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}"
              ;;
            "ls")
              echo "[ACT-MOCK] Mock PR directories:"
              echo "gs://netra-staging-terraform-state/staging/pr-123/"
              echo "gs://netra-staging-terraform-state/staging/pr-456/"
              ;;
            "rm")
              if [[ "${{ env.ACT_DRY_RUN }}" == "true" ]]; then
                echo "[ACT-MOCK-DRY-RUN] Would remove: $2"
                exit 0
              else
                echo "[ACT-MOCK] Removed: $2"
              fi
              ;;
            *)
              echo "[ACT-MOCK] Unknown gsutil command: $@"
              ;;
          esac
          exit 0
          EOF
          chmod +x ~/bin/gsutil
          export PATH="$HOME/bin:$PATH"
          echo "PATH=$HOME/bin:$PATH" >> $GITHUB_ENV

      - name: Cleanup Terraform locks
        run: |
          echo "================================================"
          echo "Terraform Lock Cleanup Tool"
          echo "================================================"
          echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Mode: ${{ github.event_name }}"
          echo "Force: ${{ github.event.inputs.force }}"
          
          # ACT-specific verbose logging
          if [[ "${{ env.ACT_MODE }}" == "true" ]]; then
            echo ""
            echo "🧪 ACT LOCAL MODE DETECTED"
            echo "- Mock GCP operations: ${{ env.ACT_MOCK_GCP }}"
            echo "- Dry run mode: ${{ env.ACT_DRY_RUN }}"
            echo "- gsutil command: $(which gsutil)"
            echo "- PATH: $PATH"
            echo ""
          fi
          echo ""
          
          SPECIFIC_PR="${{ github.event.inputs.pr_number }}"
          FORCE_REMOVE="${{ github.event.inputs.force }}"
          STALE_THRESHOLD_MINUTES="${{ env.STALE_LOCK_MINUTES }}"
          LOCKS_REMOVED=0
          LOCKS_KEPT=0
          
          # Function to check and clean a single lock
          check_and_clean_lock() {
            local LOCK_PATH="$1"
            local PR_NUM="$2"
            
            echo "----------------------------------------"
            echo "Checking PR #${PR_NUM}"
            
            if ! gsutil stat "$LOCK_PATH" 2>/dev/null; then
              echo "  Status: No lock file"
              return
            fi
            
            # Get lock metadata
            LOCK_INFO=$(gsutil cat "$LOCK_PATH" 2>/dev/null || echo "{}")
            LOCK_ID=$(echo "$LOCK_INFO" | jq -r '.ID // "unknown"')
            LOCK_HOLDER=$(echo "$LOCK_INFO" | jq -r '.Who // "unknown"')
            LOCK_CREATED=$(echo "$LOCK_INFO" | jq -r '.Created // ""')
            
            echo "  Lock ID: $LOCK_ID"
            echo "  Holder: $LOCK_HOLDER"
            echo "  Created: $LOCK_CREATED"
            
            # Calculate age
            if [[ -n "$LOCK_CREATED" ]] && [[ "$LOCK_CREATED" != "null" ]]; then
              LOCK_TIMESTAMP=$(date -d "${LOCK_CREATED}" +%s 2>/dev/null || echo "0")
              CURRENT_TIME=$(date +%s)
              AGE_SECONDS=$(( CURRENT_TIME - LOCK_TIMESTAMP ))
              AGE_MINUTES=$(( AGE_SECONDS / 60 ))
              echo "  Age: ${AGE_MINUTES} minutes"
              
              # Determine if we should remove
              SHOULD_REMOVE=false
              REASON=""
              
              if [[ "$FORCE_REMOVE" == "true" ]]; then
                SHOULD_REMOVE=true
                REASON="Force removal requested"
              elif echo "$LOCK_HOLDER" | grep -q "runner@"; then
                # GitHub Actions runner lock
                if [ $AGE_MINUTES -gt $STALE_THRESHOLD_MINUTES ]; then
                  SHOULD_REMOVE=true
                  REASON="Stale GitHub Actions lock (>${STALE_THRESHOLD_MINUTES} min)"
                fi
              else
                # Non-runner lock - use 30 minute threshold
                if [ $AGE_MINUTES -gt 30 ]; then
                  SHOULD_REMOVE=true
                  REASON="Stale lock (>30 min)"
                fi
              fi
              
              if [ "$SHOULD_REMOVE" = true ]; then
                echo "  Action: REMOVE - $REASON"
                if gsutil rm "$LOCK_PATH" 2>/dev/null; then
                  echo "  Result: ✅ Lock removed successfully"
                  LOCKS_REMOVED=$((LOCKS_REMOVED + 1))
                else
                  echo "  Result: ❌ Failed to remove lock"
                fi
              else
                echo "  Action: KEEP - Lock is active"
                LOCKS_KEPT=$((LOCKS_KEPT + 1))
              fi
            else
              # Can't determine age from lock metadata, check file stats
              LOCK_MOD_TIME=$(gsutil stat "$LOCK_PATH" | grep "Creation time:" | cut -d':' -f2- | xargs -I {} date -d "{}" +%s 2>/dev/null || echo "0")
              if [ "$LOCK_MOD_TIME" -ne "0" ]; then
                CURRENT_TIME=$(date +%s)
                AGE_MINUTES=$(( (CURRENT_TIME - LOCK_MOD_TIME) / 60 ))
                echo "  Age (from file): ${AGE_MINUTES} minutes"
                
                if [[ "$FORCE_REMOVE" == "true" ]] || [ $AGE_MINUTES -gt $STALE_THRESHOLD_MINUTES ]; then
                  echo "  Action: REMOVE - Stale based on file age"
                  if gsutil rm "$LOCK_PATH" 2>/dev/null; then
                    echo "  Result: ✅ Lock removed successfully"
                    LOCKS_REMOVED=$((LOCKS_REMOVED + 1))
                  else
                    echo "  Result: ❌ Failed to remove lock"
                  fi
                else
                  echo "  Action: KEEP - Lock is recent"
                  LOCKS_KEPT=$((LOCKS_KEPT + 1))
                fi
              else
                echo "  Warning: Unable to determine lock age"
                if [[ "$FORCE_REMOVE" == "true" ]]; then
                  echo "  Action: REMOVE - Force removal"
                  gsutil rm "$LOCK_PATH" 2>/dev/null || true
                  LOCKS_REMOVED=$((LOCKS_REMOVED + 1))
                else
                  echo "  Action: KEEP - Unable to verify if stale"
                  LOCKS_KEPT=$((LOCKS_KEPT + 1))
                fi
              fi
            fi
          }
          
          # Main cleanup logic
          if [[ -n "$SPECIFIC_PR" ]]; then
            # Clean specific PR
            echo "Cleaning locks for PR #${SPECIFIC_PR}"
            LOCK_FILE="gs://${{ env.GCP_PROJECT_ID }}-terraform-state/staging/pr-${SPECIFIC_PR}/default.tflock"
            check_and_clean_lock "$LOCK_FILE" "$SPECIFIC_PR"
          else
            # Clean all PRs
            echo "Scanning all PR environments for stale locks..."
            echo ""
            
            # List all PR directories in the state bucket
            PR_DIRS=$(gsutil ls "gs://${{ env.GCP_PROJECT_ID }}-terraform-state/staging/" 2>/dev/null | grep "pr-" || echo "")
            
            if [[ -z "$PR_DIRS" ]]; then
              echo "No PR environments found"
            else
              for PR_DIR in $PR_DIRS; do
                # Extract PR number from directory name
                PR_NUM=$(echo "$PR_DIR" | grep -oP 'pr-\K[0-9]+' || continue)
                
                if [[ -n "$PR_NUM" ]]; then
                  LOCK_FILE="${PR_DIR}default.tflock"
                  check_and_clean_lock "$LOCK_FILE" "$PR_NUM"
                fi
              done
            fi
          fi
          
          echo ""
          echo "================================================"
          echo "Summary"
          echo "================================================"
          echo "Locks removed: $LOCKS_REMOVED"
          echo "Locks kept: $LOCKS_KEPT"
          echo "Total processed: $((LOCKS_REMOVED + LOCKS_KEPT))"
          
          # Set output for potential notifications
          echo "locks_removed=$LOCKS_REMOVED" >> $GITHUB_OUTPUT
          echo "locks_kept=$LOCKS_KEPT" >> $GITHUB_OUTPUT

      - name: Report to Slack (if configured)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [[ "${{ steps.cleanup.outputs.locks_removed }}" -gt 0 ]]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"🔓 Terraform Lock Cleanup: Removed ${{ steps.cleanup.outputs.locks_removed }} stale locks\"}" \
              "$SLACK_WEBHOOK_URL" 2>/dev/null || true
          fi

  monitor-active-locks:
    name: Monitor Active Locks
    runs-on: warp-custom-default
    if: github.event_name == 'schedule'
    
    steps:
      - name: ACT Detection for Monitor Job
        run: |
          if [[ "${{ env.ACT_DETECTED }}" == "true" ]]; then
            echo "🧪 Monitor job running in ACT mode"
            echo "ACT_MODE=true" >> $GITHUB_ENV
          else
            echo "☁️ Monitor job running in GitHub Actions"
            echo "ACT_MODE=false" >> $GITHUB_ENV
          fi

      - name: Authenticate to Google Cloud
        if: env.ACT_MODE != 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_STAGING_SA_KEY }}

      - name: Set up Cloud SDK
        if: env.ACT_MODE != 'true'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Setup Mock GCP for Monitor (ACT)
        if: env.ACT_MODE == 'true'
        run: |
          echo "🧪 Setting up mock GCP for monitor job"
          mkdir -p ~/bin
          cat > ~/bin/gsutil << 'EOF'
          #!/bin/bash
          echo "[ACT-MOCK-MONITOR] gsutil $@"
          case "$1" in
            "ls")
              echo "[ACT-MOCK] Mock active locks:"
              echo "gs://netra-staging-terraform-state/staging/pr-123/default.tflock"
              echo "gs://netra-staging-terraform-state/staging/pr-456/default.tflock"
              ;;
            "cat")
              # Mock long-running lock for testing
              AGE_MINUTES=60
              echo "[ACT-MOCK] Mock lock (${AGE_MINUTES} min old): {\"ID\":\"long-running-123\",\"Who\":\"runner@act-test\",\"Created\":\"$(date -u -d "${AGE_MINUTES} minutes ago" +%Y-%m-%dT%H:%M:%S.000Z)\"}"
              ;;
            *)
              echo "[ACT-MOCK] Monitor gsutil: $@"
              ;;
          esac
          exit 0
          EOF
          chmod +x ~/bin/gsutil
          export PATH="$HOME/bin:$PATH"
          echo "PATH=$HOME/bin:$PATH" >> $GITHUB_ENV

      - name: Check for long-running locks
        run: |
          echo "Checking for long-running Terraform operations..."
          
          WARNING_THRESHOLD_MINUTES=45
          CRITICAL_THRESHOLD_MINUTES=90
          
          # List all lock files
          LOCK_FILES=$(gsutil ls -r "gs://${{ env.GCP_PROJECT_ID }}-terraform-state/staging/**/default.tflock" 2>/dev/null || echo "")
          
          WARNINGS=0
          CRITICAL=0
          
          for LOCK_FILE in $LOCK_FILES; do
            if [[ -n "$LOCK_FILE" ]]; then
              # Get lock age
              LOCK_INFO=$(gsutil cat "$LOCK_FILE" 2>/dev/null || continue)
              LOCK_CREATED=$(echo "$LOCK_INFO" | jq -r '.Created // ""')
              LOCK_HOLDER=$(echo "$LOCK_INFO" | jq -r '.Who // "unknown"')
              
              if [[ -n "$LOCK_CREATED" ]] && [[ "$LOCK_CREATED" != "null" ]]; then
                LOCK_TIMESTAMP=$(date -d "${LOCK_CREATED}" +%s 2>/dev/null || echo "0")
                CURRENT_TIME=$(date +%s)
                AGE_MINUTES=$(( (CURRENT_TIME - LOCK_TIMESTAMP) / 60 ))
                
                PR_NUM=$(echo "$LOCK_FILE" | grep -oP 'pr-\K[0-9]+' || echo "unknown")
                
                if [ $AGE_MINUTES -gt $CRITICAL_THRESHOLD_MINUTES ]; then
                  echo "🚨 CRITICAL: PR #${PR_NUM} has been locked for ${AGE_MINUTES} minutes by ${LOCK_HOLDER}"
                  CRITICAL=$((CRITICAL + 1))
                elif [ $AGE_MINUTES -gt $WARNING_THRESHOLD_MINUTES ]; then
                  echo "⚠️ WARNING: PR #${PR_NUM} has been locked for ${AGE_MINUTES} minutes by ${LOCK_HOLDER}"
                  WARNINGS=$((WARNINGS + 1))
                fi
              fi
            fi
          done
          
          if [ $CRITICAL -gt 0 ]; then
            echo "::error::Found $CRITICAL critical long-running locks (>${CRITICAL_THRESHOLD_MINUTES} minutes)"
            exit 1
          elif [ $WARNINGS -gt 0 ]; then
            echo "::warning::Found $WARNINGS long-running locks (>${WARNING_THRESHOLD_MINUTES} minutes)"
          else
            echo "✅ All Terraform locks are within normal time limits"
          fi