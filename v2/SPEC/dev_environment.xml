<?xml version="1.0" encoding="UTF-8"?>
<specification>
  <metadata>
    <title>Development Environment Configuration</title>
    <version>1.0.0</version>
    <created>2025-08-10</created>
    <author>Netra AI Team</author>
    <description>
      Specification for unified development environment with dynamic port allocation,
      service discovery, and simplified startup process.
    </description>
  </metadata>

  <features>
    <feature id="dynamic-ports">
      <name>Dynamic Port Allocation</name>
      <description>
        Backend server can automatically find and use available ports to avoid conflicts
        during development, especially when running multiple instances or tests.
      </description>
      <implementation>
        <file>run_server.py</file>
        <methods>
          <method>get_free_port() - Allocates free port using socket binding</method>
          <method>--dynamic-port flag - Enables automatic port selection</method>
          <method>--port flag - Manually specify port</method>
        </methods>
      </implementation>
    </feature>

    <feature id="service-discovery">
      <name>Service Discovery Mechanism</name>
      <description>
        Allows frontend and backend to discover each other's configuration dynamically,
        enabling flexible port assignment and multi-instance development.
      </description>
      <implementation>
        <file>scripts/service_discovery.py</file>
        <storage>.netra/backend.json and .netra/frontend.json</storage>
        <data>
          <field>host - Service hostname</field>
          <field>port - Service port number</field>
          <field>api_url - Full API URL for HTTP requests</field>
          <field>ws_url - WebSocket connection URL</field>
          <field>pid - Process ID for lifecycle management</field>
        </data>
      </implementation>
    </feature>

    <feature id="unified-launcher">
      <name>Unified Development Launcher</name>
      <description>
        Single command to start both backend and frontend with proper configuration,
        dependency checking, and graceful shutdown.
      </description>
      <implementation>
        <file>dev_launcher.py</file>
        <capabilities>
          <capability>Dependency verification</capability>
          <capability>Sequential service startup</capability>
          <capability>Health check validation</capability>
          <capability>Process lifecycle management</capability>
          <capability>Graceful shutdown on interrupt</capability>
        </capabilities>
      </implementation>
    </feature>
  </features>

  <usage>
    <quick-start>
      <title>Quick Start - Unified Development</title>
      <steps>
        <step>
          <command>python dev_launcher.py</command>
          <description>Start both backend and frontend with default configuration</description>
        </step>
      </steps>
    </quick-start>

    <advanced-usage>
      <title>Advanced Usage Options</title>
      
      <option id="dynamic-backend">
        <command>python dev_launcher.py --dynamic</command>
        <description>Use dynamic port allocation for backend (avoids port conflicts)</description>
      </option>

      <option id="custom-ports">
        <command>python dev_launcher.py --backend-port 8080 --frontend-port 3001</command>
        <description>Specify custom ports for services</description>
      </option>

      <option id="backend-only-dynamic">
        <command>python run_server.py --dynamic-port</command>
        <description>Start only backend with dynamic port</description>
      </option>

      <option id="backend-only-custom">
        <command>python run_server.py --port 8080</command>
        <description>Start only backend on specific port</description>
      </option>

      <option id="frontend-with-discovery">
        <command>cd frontend && node scripts/start_with_discovery.js</command>
        <description>Start frontend with automatic backend discovery</description>
      </option>

      <option id="check-services">
        <command>python scripts/service_discovery.py status</command>
        <description>Check status of running services</description>
      </option>

      <option id="get-service-info">
        <command>python scripts/service_discovery.py get --service backend</command>
        <description>Get backend service configuration</description>
      </option>

      <option id="clear-discovery">
        <command>python scripts/service_discovery.py clear</command>
        <description>Clear service discovery information</description>
      </option>
    </advanced-usage>

    <environment-variables>
      <title>Environment Variables</title>
      
      <variable>
        <name>BACKEND_PORT</name>
        <description>Default backend port if not specified via command line</description>
        <default>8000</default>
      </variable>

      <variable>
        <name>NEXT_PUBLIC_API_URL</name>
        <description>Backend API URL for frontend (auto-configured via service discovery)</description>
        <example>http://localhost:8000</example>
      </variable>

      <variable>
        <name>NEXT_PUBLIC_WS_URL</name>
        <description>WebSocket URL for frontend (auto-configured via service discovery)</description>
        <example>ws://localhost:8000/ws</example>
      </variable>

      <variable>
        <name>SERVER_PORT</name>
        <description>Set automatically by run_server.py to inform the app of its port</description>
      </variable>
    </environment-variables>
  </usage>

  <architecture>
    <component id="backend-server">
      <name>Backend Server (FastAPI)</name>
      <startup>
        <sequence>
          1. Parse command-line arguments for port configuration
          2. Allocate port (fixed, from env var, or dynamic)
          3. Write service discovery information to .netra/backend.json
          4. Set SERVER_PORT environment variable
          5. Start Uvicorn server with specified configuration
        </sequence>
      </startup>
    </component>

    <component id="frontend-server">
      <name>Frontend Server (Next.js)</name>
      <startup>
        <sequence>
          1. Read backend discovery from .netra/backend.json
          2. Set NEXT_PUBLIC_API_URL and NEXT_PUBLIC_WS_URL environment variables
          3. Start Next.js development server
          4. Write frontend discovery to .netra/frontend.json
        </sequence>
      </startup>
    </component>

    <component id="service-discovery">
      <name>Service Discovery</name>
      <responsibilities>
        <responsibility>Store service configuration in JSON files</responsibility>
        <responsibility>Provide API for reading/writing service information</responsibility>
        <responsibility>Track process IDs for lifecycle management</responsibility>
        <responsibility>Check if services are running</responsibility>
      </responsibilities>
    </component>

    <component id="dev-launcher">
      <name>Development Launcher</name>
      <responsibilities>
        <responsibility>Check all dependencies before startup</responsibility>
        <responsibility>Start backend server with proper configuration</responsibility>
        <responsibility>Wait for backend health check</responsibility>
        <responsibility>Start frontend with backend discovery</responsibility>
        <responsibility>Monitor processes and handle graceful shutdown</responsibility>
        <responsibility>Clean up service discovery on exit</responsibility>
      </responsibilities>
    </component>
  </architecture>

  <benefits>
    <benefit>
      <title>Eliminates Port Conflicts</title>
      <description>
        Dynamic port allocation ensures developers can run multiple instances
        or work alongside running tests without port conflicts.
      </description>
    </benefit>

    <benefit>
      <title>Simplified Startup</title>
      <description>
        Single command starts entire development stack with proper configuration
        and dependency checking.
      </description>
    </benefit>

    <benefit>
      <title>Automatic Configuration</title>
      <description>
        Frontend automatically discovers backend configuration, eliminating
        manual environment variable management.
      </description>
    </benefit>

    <benefit>
      <title>Better Developer Experience</title>
      <description>
        Clear status messages, health checks, and graceful shutdown make
        development more predictable and pleasant.
      </description>
    </benefit>

    <benefit>
      <title>Test Isolation Compatibility</title>
      <description>
        Same port allocation mechanism used in tests, ensuring consistency
        between development and testing environments.
      </description>
    </benefit>
  </benefits>

  <troubleshooting>
    <issue>
      <problem>Port already in use error</problem>
      <solution>
        Use --dynamic flag to automatically find free port:
        python dev_launcher.py --dynamic
      </solution>
    </issue>

    <issue>
      <problem>Frontend cannot connect to backend</problem>
      <solution>
        1. Check service discovery: python scripts/service_discovery.py status
        2. Ensure backend started first if running separately
        3. Clear old discovery data: python scripts/service_discovery.py clear
      </solution>
    </issue>

    <issue>
      <problem>Services don't shut down cleanly</problem>
      <solution>
        1. Use Ctrl+C to trigger graceful shutdown
        2. On Windows, use: taskkill /F /IM python.exe /IM node.exe
        3. Clear discovery: python scripts/service_discovery.py clear
      </solution>
    </issue>

    <issue>
      <problem>Missing dependencies error</problem>
      <solution>
        1. Backend: pip install -r requirements.txt
        2. Frontend: cd frontend && npm install
        3. Re-run launcher after installing dependencies
      </solution>
    </issue>
  </troubleshooting>

  <testing>
    <integration>
      <description>
        The dynamic port allocation system integrates with the existing test
        isolation framework in scripts/test_isolation.py, using the same
        get_free_port() mechanism for consistency.
      </description>
    </integration>

    <commands>
      <command>
        <name>Test with isolation</name>
        <code>python test_runner.py --mode quick</code>
        <description>Uses dynamic ports via TestIsolationManager</description>
      </command>

      <command>
        <name>Test backend with dynamic port</name>
        <code>python scripts/test_backend.py --dynamic-port</code>
        <description>Run backend tests with automatic port allocation</description>
      </command>
    </commands>
  </testing>

  <migration>
    <from-existing>
      <title>Migrating from Fixed Port Setup</title>
      <steps>
        <step>Update any hardcoded localhost:8000 references to use environment variables</step>
        <step>Replace manual startup commands with dev_launcher.py</step>
        <step>Update CI/CD scripts to use --port flag if needed</step>
        <step>Add .netra/ to .gitignore to avoid committing discovery files</step>
      </steps>
    </from-existing>
  </migration>

  <future-enhancements>
    <enhancement>
      <title>Docker Integration</title>
      <description>
        Extend service discovery to work with Docker containers, allowing
        mixed local/containerized development.
      </description>
    </enhancement>

    <enhancement>
      <title>Multi-Service Support</title>
      <description>
        Support additional services like Redis, PostgreSQL, ClickHouse with
        automatic port allocation and discovery.
      </description>
    </enhancement>

    <enhancement>
      <title>Remote Development</title>
      <description>
        Enable service discovery across network for distributed development
        teams or cloud-based development environments.
      </description>
    </enhancement>

    <enhancement>
      <title>Service Health Dashboard</title>
      <description>
        Web-based dashboard showing all running services, their configuration,
        and health status.
      </description>
    </enhancement>
  </future-enhancements>
</specification>