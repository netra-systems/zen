<?xml version="1.0" encoding="UTF-8"?>
<specification>
    <metadata>
        <name>KnowledgeBase.LearningsIndex</name>
        <type>KnowledgeRetrievalMap</type>
        <version>2.0</version>
        <description>Index map for retrieving established patterns and critical learnings.</description>
    </metadata>
    
    <retrieval-protocol>
        <title>AI Utilization Strategy</title>
        <ai-directive>AI Agents MUST consult this index before task execution to avoid known regressions.</ai-directive>
        <workflow>
            <step>1. Analyze the task description for relevant keywords/domains.</step>
            <step>2. Query this index for matching categories.</step>
            <step>3. Prioritize and integrate the `<critical-takeaway>` elements into the execution plan.</step>
            <step>4. If necessary, retrieve the detailed learning file using the `path` attribute.</step>
        </workflow>
    </retrieval-protocol>

    <categories>
        <category name="Authentication/OAuth" path="SPEC/learnings/auth.xml" keywords="JWT, Login, Session, OAuth, Token">
            <critical-takeaway>MANDATORY: All services must integrate with the shared auth service (SPEC/shared_auth_integration.xml).</critical-takeaway>
            <critical-takeaway>Ensure consistent JWT secret configuration across services (jwt-secret-mismatch).</critical-takeaway>
            <critical-takeaway>OAuth redirect URIs must point to auth service (auth.staging.netrasystems.ai), not frontend (oauth_redirect_configuration.xml).</critical-takeaway>
            <critical-takeaway>Frontend pages receiving OAuth tokens via URL must handle token extraction and storage (oauth_token_persistence.xml).</critical-takeaway>
            <critical-takeaway>Always verify OAuth configuration matches between code and provider console (oauth_deployment_verification.xml).</critical-takeaway>
        </category>
        
        <category name="Auth Service Integration" path="SPEC/learnings/auth_service_integration.xml" keywords="Auth Service, Dev Login, JWT, OAuth Flow">
            <critical-takeaway>Auth service is OAuth-first with NO /register endpoint - use OAuth or dev login.</critical-takeaway>
            <critical-takeaway>Dev login endpoint (/auth/dev/login) creates fixed dev@example.com user automatically.</critical-takeaway>
            <critical-takeaway>Auth service maintains separate auth_users table but syncs IDs with main database.</critical-takeaway>
            <critical-takeaway>Token validation via POST /auth/validate, not a TokenValidator class.</critical-takeaway>
            <critical-takeaway>Redis sessions optional in dev/staging - service healthy without Redis.</critical-takeaway>
        </category>

        <category name="Project Structure" path="SPEC/learnings/project_structure_enforcement.xml" keywords="Structure, Imports, netra_backend, Canonical">
            <critical-takeaway>THE canonical structure: netra_backend/app/ for production, netra_backend/tests/ for tests. This is PERMANENT.</critical-takeaway>
            <critical-takeaway>All imports MUST use netra_backend.app.* prefix. Fix imports, NOT the structure.</critical-takeaway>
            <critical-takeaway>Cross-service imports are FORBIDDEN. Use API clients for service communication.</critical-takeaway>
            <critical-takeaway>When imports fail, update them to match structure. NEVER move files to accommodate old patterns.</critical-takeaway>
            <critical-takeaway>Test runner uses netra_backend/tests/, dev launcher uses netra_backend.app.main:app.</critical-takeaway>
        </category>
        
        <category name="AI-Native Path Management" path="SPEC/learnings/ai_native_path_management.xml" keywords="AI-Native, Path Migration, Refactoring, Service Creation, Batch Operations, Import Management">
            <critical-takeaway>ALWAYS use batch operations for path migrations - never migrate file-by-file to avoid inconsistencies.</critical-takeaway>
            <critical-takeaway>Path migrations must be atomic - all changes in single commit with tests passing before and after.</critical-takeaway>
            <critical-takeaway>Use multi-agent coordination for large migrations: Principal (strategy), Implementation (execution), QA (verification), DevOps (deployment).</critical-takeaway>
            <critical-takeaway>New services must follow standard scaffold: {service_name}/{service_name}_core/ structure with health endpoints from start.</critical-takeaway>
            <critical-takeaway>Validate import hierarchy: Core->Models->Services->Routes->Main, never reverse imports.</critical-takeaway>
            <critical-takeaway>Configuration alignment critical: Update Python imports, Docker paths, CI/CD, env vars atomically.</critical-takeaway>
        </category>

        <category name="WebSocket" path="SPEC/learnings/websocket_message_paradox.xml" keywords="Realtime, Coroutine, Async">
            <critical-takeaway context="Error Handling">All failures MUST raise exceptions. Silent failures (e.g., auth hanging) are forbidden.</critical-takeaway>
            <critical-takeaway context="Async">Always await async operations. Verify objects are not coroutines before access.</critical-takeaway>
            <critical-takeaway context="Schema">Ensure strict alignment of message fields (e.g., 'content' vs 'text') between FE/BE.</critical-takeaway>
        </category>

        <category name="Configuration/Secrets" path="SPEC/learnings/configuration_secrets.xml" keywords="Env Vars, .env">
            <critical-takeaway>All configuration MUST utilize the unified config system. Direct `os.environ.get()` is forbidden outside the config module.</critical-takeaway>
        </category>
        
        <category name="Unified Configuration" path="SPEC/learnings/unified_configuration.xml" keywords="Config, Hot Reload, ConfigManager, Configuration, Secrets, GCP">
            <critical-takeaway>Configuration MUST use single source of truth at netra_backend.app.config. 110+ duplicate config files have been REMOVED.</critical-takeaway>
            <critical-takeaway>NEVER import removed files: config_environment.py, config_loader.py, config_manager.py, config_envvars.py - they're DELETED.</critical-takeaway>
            <critical-takeaway>Hot reload enables zero-downtime updates via CONFIG_HOT_RELOAD=true and reload_config().</critical-takeaway>
            <critical-takeaway>All configuration access uses: from netra_backend.app.config import get_config.</critical-takeaway>
            <critical-takeaway>Configuration validation is MANDATORY: validate_configuration() must pass before deployment.</critical-takeaway>
            <critical-takeaway>Secrets use unified SecretManager with GCP Secret Manager (staging/production) or local files (dev).</critical-takeaway>
        </category>

        <category name="CORS/Dynamic Ports" path="SPEC/learnings/cors_dynamic_ports.xml" keywords="CORS, Dynamic Ports, Localhost, Development">
            <critical-takeaway>CRITICAL: CORS configuration MUST support dynamic ports in development. Pattern matching for localhost with ANY port must be checked FIRST.</critical-takeaway>
            <critical-takeaway>Use DynamicCORSMiddleware when CORS_ORIGINS=* to handle credentials properly (RFC 6454).</critical-takeaway>
        </category>

        <category name="Testing" path="SPEC/learnings/testing.xml" keywords="TDD, Feature Flags, Pytest, Jest">
            <critical-takeaway>Adhere to the Feature Flag TDD workflow (feature-flags-tdd-workflow).</critical-takeaway>
            <critical-takeaway>Tests must validate REAL functionality, not mocks (frontend-test-paradox-report).</critical-takeaway>
        </category>
        
        <category name="Test Imports" path="SPEC/learnings/test_import_fixes.xml" keywords="Imports, ModuleNotFoundError, PYTHONPATH, Test Setup">
            <critical-takeaway>All imports MUST use absolute imports with netra_backend namespace (e.g., from netra_backend.app.db import models).</critical-takeaway>
            <critical-takeaway>Auth service endpoints use /auth prefix, NOT /api/v1/auth.</critical-takeaway>
            <critical-takeaway>Use /auth/dev/login for testing (no registration endpoint exists).</critical-takeaway>
            <critical-takeaway>Test files use netra_backend.tests.* namespace for test imports.</critical-takeaway>
        </category>
        
        <category name="Test Environment" path="SPEC/learnings/test_environment_fixes.xml" keywords="Windows, PYTHONPATH, Pytest, Environment">
            <critical-takeaway>Set PYTHONPATH explicitly on Windows: set PYTHONPATH=C:\path\to\app</critical-takeaway>
            <critical-takeaway>Run tests from app directory for proper import resolution.</critical-takeaway>
            <critical-takeaway>Use -m "not real_services" to skip external API calls in tests.</critical-takeaway>
            <critical-takeaway>Test size limits: 300 lines per file, 8 lines per function (many violations exist).</critical-takeaway>
        </category>

        <category name="Frontend" path="SPEC/learnings/frontend.xml" keywords="Zustand, React, TypeScript">
            <critical-takeaway context="Zustand">Use individual selectors to prevent infinite loops. See SPEC/conventions.xml#zustand-selectors.</critical-takeaway>
        </category>

        <category name="Microservice Independence" path="SPEC/independent_services.xml" keywords="Microservice, Docker, Service">
            <critical-takeaway>CRITICAL: Microservices MUST be 100% independent. NO imports from the main `netra_backend/app/` module. Do not name internal modules 'app'.</critical-takeaway>
        </category>

        <category name="Health Checks" path="SPEC/learnings/health_checks.xml" keywords="Health, Ready, Readiness, Liveness">
            <critical-takeaway>Health check endpoints must initialize database connections lazily if not already initialized.</critical-takeaway>
            <critical-takeaway>Auth service requires /health/ready endpoint on configured port (8080 default, not 8001).</critical-takeaway>
            <critical-takeaway>Database health checks must handle uninitialized async_engine gracefully by calling initialize_postgres().</critical-takeaway>
        </category>

        <category name="Database/AsyncIO" path="SPEC/learnings/database_asyncio.xml" keywords="AsyncSession, Database, Postgres, ClickHouse">
            <critical-takeaway>Functions marked as async must actually await something (postgres-session-async-function-paradox).</critical-takeaway>
            <critical-takeaway>ClickHouse driver: Use OperationalError instead of NetworkError (which doesn't exist) for network-related exceptions.</critical-takeaway>
        </category>
        
        <category name="FastAPI/Dependencies" path="SPEC/learnings/fastapi_dependencies.xml" keywords="FastAPI, Depends, AsyncContextManager, async with, async for">
            <critical-takeaway>Never use @asynccontextmanager decorated functions directly with FastAPI's Depends() - create wrapper functions.</critical-takeaway>
            <critical-takeaway>Use 'async with' for @asynccontextmanager functions, NOT 'async for' (context managers != iterators).</critical-takeaway>
            <critical-takeaway>Context managers implement __aenter__/__aexit__, iterators implement __aiter__/__anext__.</critical-takeaway>
        </category>

        <category name="Database/Migration" path="SPEC/learnings/alembic_asyncpg_greenlet.xml" keywords="Alembic, Migration, AsyncPG, Greenlet, SQLAlchemy">
            <critical-takeaway>Alembic requires synchronous database URL - remove asyncpg driver for migrations.</critical-takeaway>
            <critical-takeaway>Separate sync migration URLs from async application URLs to avoid greenlet errors.</critical-takeaway>
        </category>

        <category name="Dev Launcher" path="SPEC/learnings/dev_launcher.xml" keywords="Development, Startup, Local, Health Checks, Configuration">
            <critical-takeaway>CONSOLIDATED: All dev launcher learnings now in single file. SECRET_KEY must be 64+ characters.</critical-takeaway>
            <critical-takeaway>Health checks must use dynamic ports from .service_discovery/*.json files.</critical-takeaway>
            <critical-takeaway>Extended timeouts required: Backend/Auth 30s, Frontend 60s, Overall 120s.</critical-takeaway>
        </category>

        <category name="Deployment" path="SPEC/learnings/deployment_staging.xml" keywords="GCP, Cloud Run, Docker, Staging, SSL, Database, OAuth, Frontend, Proxy">
            <critical-takeaway>Use gunicorn with uvicorn workers for Cloud Run (cloud-run-uvicorn-workers).</critical-takeaway>
            <critical-takeaway>DATABASE_URL in staging/production MUST include sslmode=require parameter for Cloud SQL connections.</critical-takeaway>
            <critical-takeaway>Frontend NEXT_PUBLIC_API_URL must point to backend API URL (e.g., https://api.staging.netrasystems.ai) for proxy rewrites to work.</critical-takeaway>
            <critical-takeaway>Health check /health/ready endpoint in staging may fail with 503 if database connectivity isn't properly configured - check DATABASE_URL and SSL settings.</critical-takeaway>
            <critical-takeaway>OAuth flow requires auth service at separate domain (e.g., auth.staging.netrasystems.ai) with proper CORS and callback URL configuration.</critical-takeaway>
            <critical-takeaway>CRITICAL: USE_OAUTH_PROXY must be "true" for backend to validate tokens through auth service, even if OAUTH_PROXY_URL is correctly set.</critical-takeaway>
        </category>

        <category name="GitHub Actions" path="SPEC/learnings/github_actions.xml" keywords="CI/CD, Pipeline, Workflow">
            <critical-takeaway>Test failures must propagate - see test-exit-code-propagation learning.</critical-takeaway>
        </category>

        <category name="Architecture/Compliance" path="SPEC/learnings/compliance_improvements.xml" keywords="300/8, Compliance, Architecture">
            <critical-takeaway>Maintain 450-line file limit and 25-line function limit. Use compliance check script.</critical-takeaway>
        </category>

        <category name="Context Optimization" path="SPEC/learnings/context_optimization.xml" keywords="AI Context, Token Optimization">
            <critical-takeaway>Avoid context bloat from test files and long functions. Monitor context efficiency.</critical-takeaway>
        </category>

        <category name="Type Safety" path="SPEC/learnings/type_safety.xml" keywords="Types, Pydantic, TypeScript">
            <critical-takeaway>Maintain single source of truth for types. Avoid circular imports.</critical-takeaway>
        </category>

        <category name="E2E Testing" path="SPEC/learnings/e2e_testing.xml" keywords="End-to-End, Integration, Circuit Breaker">
            <critical-takeaway>Use circuit breaker patterns. Ensure proper fixture dependencies.</critical-takeaway>
        </category>

        <category name="Startup" path="SPEC/learnings/startup.xml" keywords="Initialization, Boot, Config">
            <critical-takeaway>Startup errors often cascade - fix configuration first, then secrets, then connections.</critical-takeaway>
        </category>

        <category name="State Management/Validation" path="SPEC/learnings/state_validation.xml" keywords="Pydantic, Validation, State">
            <critical-takeaway>Always provide defaults for Pydantic model fields unless absolutely critical.</critical-takeaway>
        </category>


        <category name="Observability" path="SPEC/learnings/observability.xml" keywords="Logging, Monitoring, Metrics">
            <critical-takeaway>Implement modular observability architecture with correlation ID tracking.</critical-takeaway>
            <critical-takeaway context="Loguru">Use f-strings or {} placeholders for loguru logging, not %s format strings (loguru-format-strings).</critical-takeaway>
        </category>

        <category name="Environment Detection" path="SPEC/learnings/environment_detection.xml" keywords="Environment, Staging, Production">
            <critical-takeaway>Environment defaults must NEVER be "production" - always default to staging for safety.</critical-takeaway>
        </category>

        <category name="Bad Test Detection" path="SPEC/learnings/bad_test_detection.xml" keywords="Test Health, Flaky Tests">
            <critical-takeaway>Track and fix consistently failing tests. Use bad test detection reports.</critical-takeaway>
        </category>

        <category name="Demo Readiness" path="SPEC/learnings/demo_readiness.xml" keywords="Demo, Presentation, Testing">
            <critical-takeaway>Ensure comprehensive demo preparation with all features tested.</critical-takeaway>
        </category>

        <category name="Scripting/Automation" path="SPEC/learnings/scripting_preference.xml" keywords="Script, Shell, PowerShell, Bash, Python, Automation">
            <critical-takeaway>ALWAYS use Python for scripts instead of shell/PowerShell for cross-platform compatibility.</critical-takeaway>
            <critical-takeaway>Convert existing shell scripts to Python during refactoring.</critical-takeaway>
            <critical-takeaway>Use subprocess.run() for external commands and pathlib for file operations.</critical-takeaway>
        </category>
        
        <category name="Database/CloudSQL" path="SPEC/learnings/cloud_sql_url_handling.xml" keywords="Cloud SQL, Database URL, Unix Socket, AsyncPG, PostgreSQL">
            <critical-takeaway>Keep database URL conversion simple - only change scheme from postgresql:// to postgresql+asyncpg://</critical-takeaway>
            <critical-takeaway>Convert sslmode= to ssl= for asyncpg (except for Unix socket connections)</critical-takeaway>
            <critical-takeaway>Cloud SQL Unix socket URLs work with format: postgresql://user:pass@/db?host=/cloudsql/project:region:instance</critical-takeaway>
        </category>
        
        <category name="Database/URLConsistency" path="SPEC/learnings/database_url_consistency.xml" keywords="Database URL, Secret Management, Cloud SQL Proxy, Service Consistency">
            <critical-takeaway>All services MUST use the same DATABASE_URL secret for consistency</critical-takeaway>
            <critical-takeaway>When using Cloud SQL proxy, use Unix socket format not direct IP</critical-takeaway>
            <critical-takeaway>Verify IP addresses in secrets match actual Cloud SQL instances</critical-takeaway>
        </category>
        
        <category name="Frontend URL Configuration" path="SPEC/frontend_base_url_configuration.xml" keywords="Base URL, URL Construction, apiClientWrapper, Invalid URL, Frontend Config">
            <critical-takeaway>NEVER use empty string as base URL - use window.location.origin in browser contexts</critical-takeaway>
            <critical-takeaway>Base URL must always be a valid URL for the JavaScript URL constructor</critical-takeaway>
            <critical-takeaway>Use window.location.origin for browser, full backend URL for SSR contexts</critical-takeaway>
            <critical-takeaway>Validate URL construction to prevent "Failed to construct 'URL': Invalid base URL" errors</critical-takeaway>
        </category>
        
        <category name="GCP Database Connection Failures" path="SPEC/learnings/gcp_database_connection_failures.xml" keywords="GCP, Database, Connection, sslmode, asyncpg, Cloud SQL, Authentication">
            <critical-takeaway>Backend health checks must convert sslmode= to ssl= for asyncpg connections</critical-takeaway>
            <critical-takeaway>Use Unix socket format for Cloud SQL proxy connections: postgresql://user:pass@/db?host=/cloudsql/instance</critical-takeaway>
            <critical-takeaway>Cloud SQL connections MUST include sslmode=require even with Unix sockets in staging/production</critical-takeaway>
            <critical-takeaway>Both backend and auth services must have Cloud SQL proxy configured</critical-takeaway>
            <critical-takeaway>Verify database credentials match actual Cloud SQL users and passwords</critical-takeaway>
        </category>
        
        <category name="Pragmatic Rigor/Resilience" path="SPEC/learnings/pragmatic_rigor.xml" keywords="Pragmatic, Rigor, Resilience, Postel, Duck Typing, Validation, Fallback, Progressive">
            <critical-takeaway>Focus on minimum constraints necessary for correctness, not maximum constraints for purity (pragmatic-rigor-over-rigid-purity).</critical-takeaway>
            <critical-takeaway>Default to resilience with relaxed configuration - systems should default to functional, permissive states (default-to-resilience).</critical-takeaway>
            <critical-takeaway>Apply Postel's Law: "Be conservative in what you send, liberal in what you accept" for interface design (postels-law-adherence).</critical-takeaway>
            <critical-takeaway>Use progressive validation modes (WARN, ENFORCE_CRITICAL, ENFORCE_ALL) instead of binary strict/permissive (progressive-validation-modes).</critical-takeaway>
            <critical-takeaway>Implement fallback behaviors and graceful degradation rather than hard failures (fallback-behaviors).</critical-takeaway>
            <critical-takeaway>Prefer duck typing over strict isinstance() checks - focus on behavior over inheritance (duck-typing-over-isinstance).</critical-takeaway>
        </category>
    </categories>
</specification>