<?xml version="1.0" encoding="UTF-8"?>
<deployment_learnings>
  <metadata>
    <created>2025-08-18</created>
    <purpose>Document deployment process learnings to prevent regression</purpose>
    <category>deployment</category>
  </metadata>

  <critical_info>
    <project_id>netra-staging</project_id>
    <region>us-central1</region>
    <registry>us-central1-docker.pkg.dev</registry>
    <repository>netra-staging/netra-staging</repository>
  </critical_info>

  <service_names>
    <service name="backend" exact="netra-backend-staging"/>
    <service name="frontend" exact="netra-frontend-staging"/>
    <service name="auth" exact="netra-auth-service"/>
  </service_names>

  <authentication>
    <correct>
      <key_file>gcp-staging-sa-key.json</key_file>
      <service_account>netra-staging-deploy@netra-staging.iam.gserviceaccount.com</service_account>
      <command>gcloud auth activate-service-account --key-file=gcp-staging-sa-key.json</command>
    </correct>
    <incorrect>
      <key_file>staging-deploy-key.json</key_file>
      <note>This file does not exist</note>
    </incorrect>
  </authentication>

  <docker_files>
    <backend>Dockerfile.backend</backend>
    <frontend>Dockerfile.frontend.staging</frontend>
    <auth>Dockerfile.auth</auth>
    <note>Frontend uses .staging suffix, others don't</note>
  </docker_files>

  <build_commands>
    <backend>
      docker build -t us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-backend-staging:latest -f Dockerfile.backend .
    </backend>
    <frontend>
      docker build -t us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-frontend-staging:latest -f Dockerfile.frontend.staging .
    </frontend>
    <auth>
      docker build -t us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-auth-service:latest -f Dockerfile.auth .
    </auth>
  </build_commands>

  <deployment_steps>
    <step order="1">
      <action>Authenticate service account</action>
      <commands>
        <command>gcloud auth activate-service-account --key-file=gcp-staging-sa-key.json</command>
        <command>gcloud config set project netra-staging</command>
      </commands>
    </step>
    <step order="2">
      <action>Configure Docker for Artifact Registry</action>
      <command>gcloud auth configure-docker us-central1-docker.pkg.dev --quiet</command>
    </step>
    <step order="3">
      <action>Build Docker images</action>
      <note>Can be done in parallel</note>
    </step>
    <step order="4">
      <action>Push images to Artifact Registry</action>
      <commands>
        <command>docker push us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-backend-staging:latest</command>
        <command>docker push us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-frontend-staging:latest</command>
        <command>docker push us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-auth-service:latest</command>
      </commands>
    </step>
    <step order="5">
      <action>Deploy to Cloud Run</action>
      <commands>
        <command>gcloud run deploy netra-backend-staging --image us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-backend-staging:latest --region us-central1</command>
        <command>gcloud run deploy netra-frontend-staging --image us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-frontend-staging:latest --region us-central1</command>
        <command>gcloud run deploy netra-auth-service --image us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-auth-service:latest --region us-central1</command>
      </commands>
    </step>
  </deployment_steps>

  <known_issues>
    <issue>
      <problem>deploy-staging-reliable.ps1 has syntax errors</problem>
      <solution>Use manual commands instead of the script</solution>
    </issue>
    <issue>
      <problem>Wrong project ID used (netra-systems)</problem>
      <solution>Always use netra-staging</solution>
    </issue>
    <issue>
      <problem>Wrong Dockerfile names</problem>
      <solution>Check actual file names with ls/dir command first</solution>
    </issue>
    <issue>
      <problem>Service account lacks iam.serviceAccounts.actAs permission</problem>
      <error>PERMISSION_DENIED: Permission 'iam.serviceaccounts.actAs' denied on service account</error>
      <solution>Need owner or admin to grant roles/iam.serviceAccountUser to netra-staging-deploy@netra-staging.iam.gserviceaccount.com</solution>
      <workaround>Images are successfully pushed to Artifact Registry. Can be deployed by someone with proper permissions</workaround>
    </issue>
  </known_issues>

  <environment_variables>
    <note>Set these before deployment if needed</note>
    <var name="GOOGLE_APPLICATION_CREDENTIALS">gcp-staging-sa-key.json</var>
    <var name="PROJECT_ID">netra-staging</var>
    <var name="REGION">us-central1</var>
  </environment_variables>

  <deployment_status date="2025-08-18">
    <success>
      <item>All three Docker images built successfully</item>
      <item>Images pushed to Artifact Registry at us-central1-docker.pkg.dev/netra-staging/netra-staging/</item>
      <item>Services already exist in Cloud Run</item>
    </success>
    <images_available>
      <backend>us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-backend-staging:latest</backend>
      <frontend>us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-frontend-staging:latest</frontend>
      <auth>us-central1-docker.pkg.dev/netra-staging/netra-staging/netra-auth-service:latest</auth>
    </images_available>
    <pending>
      <item>Cloud Run deployment requires admin to grant iam.serviceAccountUser role</item>
      <command_to_fix>gcloud projects add-iam-policy-binding netra-staging --member="serviceAccount:netra-staging-deploy@netra-staging.iam.gserviceaccount.com" --role="roles/iam.serviceAccountUser"</command_to_fix>
    </pending>
  </deployment_status>
</deployment_learnings>