<?xml version="1.0" encoding="UTF-8"?>
<learning>
    <title>ClickHouse Staging Secret Mapping Critical Fix</title>
    <date>2025-08-31</date>
    <category>deployment</category>
    <subcategory>gcp-secrets</subcategory>
    <severity>critical</severity>
    
    <problem>
        <description>
            Backend service fails to start in staging environment due to missing ClickHouse password.
            The service crashes with authentication errors when attempting to connect to ClickHouse Cloud.
        </description>
        <error_message>
            ClickHouse connection failed: Authentication error - password required
        </error_message>
        <affected_services>
            <service>netra-backend-staging</service>
            <url>https://netra-backend-staging-pnovr5vsba-uc.a.run.app</url>
        </affected_services>
    </problem>
    
    <root_cause>
        <analysis method="5-whys">
            <why level="1">Backend service not running - ClickHouse connection fails at startup</why>
            <why level="2">ClickHouse authentication fails - CLICKHOUSE_PASSWORD is empty</why>
            <why level="3">Password not loaded from GCP Secret Manager - secret not mapped</why>
            <why level="4">deploy_to_gcp.py missing CLICKHOUSE_PASSWORD in --set-secrets</why>
            <why level="5">Configuration gap between intent and implementation</why>
        </analysis>
        <primary_issue>
            The deployment script creates the secret "clickhouse-default-password-staging" 
            but doesn't map it to the CLICKHOUSE_PASSWORD environment variable in Cloud Run.
        </primary_issue>
    </root_cause>
    
    <solution>
        <changes>
            <change file="scripts/deploy_to_gcp.py" line="678">
                <description>Add CLICKHOUSE_PASSWORD to backend service secret mappings</description>
                <before>
                    "--set-secrets", "...ANTHROPIC_API_KEY=anthropic-api-key-staging:latest"
                </before>
                <after>
                    "--set-secrets", "...ANTHROPIC_API_KEY=anthropic-api-key-staging:latest,CLICKHOUSE_PASSWORD=clickhouse-default-password-staging:latest"
                </after>
            </change>
            
            <change file="scripts/deploy_to_gcp.py" line="848">
                <description>Add to required backend secrets validation list</description>
                <before>
                    "redis-password-staging"
                    # anthropic-api-key-staging is optional
                </before>
                <after>
                    "redis-password-staging",
                    "clickhouse-default-password-staging"  # Required for ClickHouse authentication
                    # anthropic-api-key-staging is optional
                </after>
            </change>
            
            <change file="netra_backend/app/core/configuration/database.py" line="305">
                <description>Add explicit validation for staging ClickHouse password</description>
                <after>
                    # CRITICAL: Fail fast in staging if ClickHouse password is missing
                    if not password and self._environment == "staging":
                        raise ConfigurationError(
                            "CLICKHOUSE_PASSWORD is required in staging but not configured. "
                            "Please ensure the secret 'clickhouse-default-password-staging' is properly mapped in Cloud Run."
                        )
                </after>
            </change>
            
            <change file="config/staging.env" line="21">
                <description>Document secret source for clarity</description>
                <after>
                    # CLICKHOUSE_PASSWORD is loaded from GCP Secret Manager
                    # Secret name: clickhouse-default-password-staging
                    # DO NOT SET HERE - Will be injected by Cloud Run via --set-secrets
                    CLICKHOUSE_PASSWORD=
                </after>
            </change>
        </changes>
    </solution>
    
    <prevention>
        <recommendation>
            Always validate that all secrets created in setup_secrets() are also mapped
            in the deployment command's --set-secrets parameter.
        </recommendation>
        <recommendation>
            Use the verify_clickhouse_fix.py script before deployment to ensure
            all configuration requirements are met.
        </recommendation>
        <recommendation>
            Consider creating a centralized secret mapping configuration to avoid
            duplication between secret creation and secret mapping.
        </recommendation>
    </prevention>
    
    <verification>
        <steps>
            <step>Run python scripts/verify_clickhouse_fix.py to validate configuration</step>
            <step>Check secret exists: gcloud secrets describe clickhouse-default-password-staging</step>
            <step>Deploy backend: python scripts/deploy_to_gcp.py --project netra-staging --service backend</step>
            <step>Monitor logs: gcloud run logs read netra-backend-staging --project netra-staging</step>
        </steps>
    </verification>
    
    <impact>
        <business_value>
            Without this fix, the entire staging environment is non-functional,
            blocking all testing and validation workflows. This impacts the ability
            to validate changes before production deployment.
        </business_value>
        <technical_debt>
            Multiple configuration sources (staging.env, deploy_to_gcp.py, GCP secrets)
            create confusion and increase risk of configuration drift.
        </technical_debt>
    </impact>
    
    <related_files>
        <file>scripts/deploy_to_gcp.py</file>
        <file>netra_backend/app/core/configuration/database.py</file>
        <file>netra_backend/app/db/clickhouse.py</file>
        <file>config/staging.env</file>
        <file>scripts/verify_clickhouse_fix.py</file>
        <file>CLICKHOUSE_STAGING_FIX_REPORT.md</file>
    </related_files>
    
    <keywords>
        <keyword>clickhouse</keyword>
        <keyword>staging</keyword>
        <keyword>gcp-secrets</keyword>
        <keyword>cloud-run</keyword>
        <keyword>deployment</keyword>
        <keyword>authentication</keyword>
        <keyword>secret-manager</keyword>
    </keywords>
</learning>