<?xml version="1.0" encoding="UTF-8"?>
<specification>
    <metadata>
        <name>Learnings - Infrastructure/Secret Management</name>
        <type>learnings</type>
        <category>Infrastructure/Secret Management</category>
        <version>1.0</version>
        <last_updated>2025-08-16</last_updated>
        <description>Learnings and fixes for Infrastructure/Secret Management</description>
    </metadata>
    
    <learnings>
        <learning id="staging-secrets-loading-configuration">
                    <title>Staging Secrets Loading Configuration Error</title>
                    <date>2025-08-15</date>
                    <category>Infrastructure/Secret Management</category>
                    <description>
                        Staging environment failed to load secrets from Google Secret Manager due to missing environment 
                        variables and incorrect secret references in Terraform configuration.
                    </description>
                    <symptoms>
                        <symptom>Error: File "/app/app/config.py", line 448, settings = get_config()</symptom>
                        <symptom>ConfigurationError during application startup</symptom>
                        <symptom>Logs showing "No secrets loaded from Google Secret Manager"</symptom>
                        <symptom>SecretManager using wrong project ID (defaulting to production)</symptom>
                    </symptoms>
                    <root-causes>
                        <cause>Missing GCP_PROJECT_ID_NUMERICAL_STAGING environment variable in Cloud Run</cause>
                        <cause>Missing SECRET_MANAGER_PROJECT_ID fallback environment variable</cause>
                        <cause>LOAD_SECRETS environment variable not set to "true"</cause>
                        <cause>Environment variable names mismatch (GOOGLE_GEMINI_API_KEY vs GEMINI_API_KEY)</cause>
                        <cause>Secret references using hardcoded values instead of Cloud Run secret integration</cause>
                    </root-causes>
                    <solution>
                        <step>Add GCP_PROJECT_ID_NUMERICAL_STAGING env var with numerical project ID</step>
                        <step>Add SECRET_MANAGER_PROJECT_ID as fallback</step>
                        <step>Set LOAD_SECRETS=true to enable secret loading in staging</step>
                        <step>Fix environment variable names to match application expectations</step>
                        <step>Update all secret references to use value_from.secret_key_ref</step>
                        <step>Add project_id_numerical variable to Terraform for proper configuration</step>
                    </solution>
                    <terraform-changes>
                        <change>
                            Added environment variables:
                            env {
                              name  = "GCP_PROJECT_ID_NUMERICAL_STAGING"
                              value = var.project_id_numerical != "" ? var.project_id_numerical : var.project_id
                            }
                            env {
                              name  = "SECRET_MANAGER_PROJECT_ID"
                              value = var.project_id_numerical != "" ? var.project_id_numerical : var.project_id
                            }
                            env {
                              name  = "LOAD_SECRETS"
                              value = "true"
                            }
                        </change>
                        <change>
                            Fixed environment variable names:
                            GOOGLE_GEMINI_API_KEY -> GEMINI_API_KEY
                            SECRET_KEY -> JWT_SECRET_KEY
                            GOOGLE_OAUTH_CLIENT_ID -> GOOGLE_CLIENT_ID
                            GOOGLE_OAUTH_CLIENT_SECRET -> GOOGLE_CLIENT_SECRET
                        </change>
                        <change>
                            Updated secret references to use Cloud Run integration:
                            env {
                              name  = "GEMINI_API_KEY"
                              value_from {
                                secret_key_ref {
                                  name = "gemini-api-key-staging"
                                  key  = "latest"
                                }
                              }
                            }
                        </change>
                    </terraform-changes>
                    <files-modified>
                        <file>terraform-gcp/main.tf - Added env vars and fixed secret references</file>
                        <file>terraform-gcp/variables.tf - Added project_id_numerical variable</file>
                        <file>scripts/create_staging_secrets.py - Updated to create required secrets</file>
                        <file>docs/STAGING_SECRETS_TROUBLESHOOTING.md - Created comprehensive guide</file>
                    </files-modified>
                    <commands>
                        <command>gcloud projects describe netra-staging --format="value(projectNumber)"</command>
                        <command>python scripts/create_staging_secrets.py netra-staging</command>
                        <command>cd terraform-gcp && terraform apply -var="project_id=netra-staging" -var="project_id_numerical=YOUR_NUMERICAL_ID"</command>
                    </commands>
                    <prevention>
                        <item>Always set GCP_PROJECT_ID_NUMERICAL_STAGING for staging deployments</item>
                        <item>Ensure LOAD_SECRETS=true is set for non-development environments</item>
                        <item>Use consistent environment variable names between Terraform and application</item>
                        <item>Test secret loading locally with scripts/test_staging_config.py</item>
                        <item>Document numerical project IDs for all environments</item>
                    </prevention>
                </learning>

    </learnings>
</specification>