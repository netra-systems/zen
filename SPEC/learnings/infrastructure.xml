<?xml version="1.0" encoding="UTF-8"?>
<specification>
    <metadata>
        <name>Learnings - Infrastructure</name>
        <type>learnings</type>
        <category>Infrastructure</category>
        <version>1.0</version>
        <last_updated>2025-08-17</last_updated>
        <description>Learnings and fixes for Infrastructure</description>
    </metadata>
    
    <learnings>
        <learning id="staging-project-name">
                    <title>GCP Staging Project Configuration</title>
                    <date>2025-08-15</date>
                    <category>Infrastructure</category>
                    <description>
                        The GCP project for Netra staging deployments is "netra-staging".
                        This is the project ID that should be used for all staging environment deployments.
                    </description>
                    <details>
                        <item>Project ID: netra-staging</item>
                        <item>Used for PR-based staging deployments</item>
                        <item>Contains shared infrastructure resources (VPC, databases, Redis)</item>
                        <item>Cloud Run services are deployed to this project</item>
                    </details>
                    <commands>
                        <command>gcloud config set project netra-staging</command>
                        <command>gcloud auth application-default set-quota-project netra-staging</command>
                    </commands>
                </learning>


        <learning id="github-actions-runner-requirement">
                    <title>GitHub Actions Must Use warp-custom-default Runner</title>
                    <date>2025-08-17</date>
                    <category>Infrastructure</category>
                    <priority>CRITICAL</priority>
                    <description>
                        ALL GitHub Actions workflows MUST use runs-on: warp-custom-default.
                        This is a MANDATORY requirement for all workflows without exception.
                        Never use ubuntu-latest or any other runner type.
                    </description>
                    <root-causes>
                        <cause>Custom runner infrastructure requirement for Netra project</cause>
                        <cause>Specific tooling and configuration available only on warp-custom-default runners</cause>
                        <cause>Performance and security requirements mandate custom runner usage</cause>
                    </root-causes>
                    <solution>
                        <step>Always use runs-on: warp-custom-default for all GitHub Actions jobs</step>
                        <step>For ACT local testing compatibility, use conditional: ${{ github.event.act && 'ubuntu-latest' || 'warp-custom-default' }}</step>
                        <step>Check all workflow files to ensure compliance with this requirement</step>
                    </solution>
                    <files-modified>
                        <file>.github/workflows/*.yml - All workflow files updated to use warp-custom-default</file>
                        <file>SPEC/github_actions.xml - Added mandatory runner requirement section</file>
                    </files-modified>
                    <examples>
                        <correct>
                            jobs:
                              build:
                                runs-on: warp-custom-default
                        </correct>
                        <incorrect>
                            jobs:
                              build:
                                runs-on: ubuntu-latest  # WRONG - Must use warp-custom-default
                        </incorrect>
                    </examples>
                    <validation>
                        <command>grep -r "runs-on:" .github/workflows/ | grep -v "warp-custom-default"</command>
                        <expected>Should return no results (except ACT conditional expressions)</expected>
                    </validation>
                </learning>

    </learnings>
</specification>