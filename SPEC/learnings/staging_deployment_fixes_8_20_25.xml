<?xml version="1.0" encoding="UTF-8"?>
<staging_deployment_fixes>
  <metadata>
    <created>2025-08-20</created>
    <summary>Complete fixes and learnings from staging deployment issues</summary>
  </metadata>

  <issues_fixed>
    <issue id="backend_configuration">
      <problem>Backend service failing due to missing LLM API keys</problem>
      <solution>
        - Ensured GEMINI_API_KEY secret exists in Secret Manager
        - Updated Cloud Run deployment to reference correct secret: gemini-api-key-staging:latest
        - Made all other LLM keys optional (OPENAI_API_KEY, ANTHROPIC_API_KEY)
      </solution>
    </issue>

    <issue id="database_connection">
      <problem>Auth service database connection timeout - wrong IP address</problem>
      <solution>
        - Used correct Cloud SQL instance: staging-shared-postgres
        - Added Cloud SQL connection annotation in Cloud Run
        - Used correct database URL secret: database-url-staging:latest
      </solution>
    </issue>

    <issue id="docker_images">
      <problem>Docker images not found in GCR</problem>
      <solution>
        - Built and pushed images with correct tags
        - Used gcr.io/netra-staging/backend:latest format
        - Tagged images with commit hash for PR deployments
      </solution>
    </issue>

    <issue id="terraform_auth">
      <problem>Terraform authorization failures</problem>
      <solution>
        - Re-authenticated with: gcloud auth application-default login
        - Set correct project: gcloud config set project netra-staging
      </solution>
    </issue>
    
    <issue id="auth_duplicate_database">
      <problem>Auth service had duplicate database connections causing timeout in staging</problem>
      <root_cause>
        - Auth service had TWO database connection modules:
        - auth_core/database/connection.py (auth_db) - the primary connection
        - auth_core/database/main_db_sync.py (main_db_sync) - duplicate/redundant
        - Both tried to connect to the database during startup
        - The auth_db connection was timing out in staging
      </root_cause>
      <solution>
        - REMOVED main_db_sync.py completely (deleted file)
        - Updated auth_routes.py to remove main_db_sync imports
        - Auth service now uses SINGLE database connection via auth_db
        - Uses same DATABASE_URL environment variable as main app
        - No separate "auth database" - uses same database as main app
      </solution>
      <prevention>
        - Created test_single_database.py to prevent regression
        - Tests verify only ONE database initialization occurs
        - Tests verify main_db_sync module cannot be imported
      </prevention>
    </issue>
  </issues_fixed>

  <configuration_cleanup>
    <duplicate_secrets>
      <found>
        - database-url-staging (primary - use this)
        - database-url-staging-asyncpg (legacy - should be removed)
      </found>
      <action>Use only database-url-staging for all services</action>
    </duplicate_secrets>

    <service_names>
      <correct>
        - Backend: netra-backend-staging
        - Frontend: netra-frontend-staging  
        - Auth: netra-auth-service
      </correct>
      <pr_branch_pattern>
        - Format: {service}-pr-{branch_name}
        - Example: backend-pr-branch-8-16-afternoon
      </pr_branch_pattern>
    </service_names>
  </configuration_cleanup>

  <working_deployment_commands>
    <backend>
      <command>
gcloud run deploy netra-backend-staging \
  --image gcr.io/netra-staging/backend:latest \
  --platform managed \
  --region us-central1 \
  --project netra-staging \
  --allow-unauthenticated \
  --port 8080 \
  --memory 2Gi \
  --cpu 2 \
  --min-instances 1 \
  --max-instances 10 \
  --set-env-vars ENVIRONMENT=staging \
  --add-cloudsql-instances netra-staging:us-central1:staging-shared-postgres \
  --set-secrets="DATABASE_URL=database-url-staging:latest,GEMINI_API_KEY=gemini-api-key-staging:latest" \
  --timeout 60
      </command>
    </backend>

    <auth_service>
      <command>
gcloud run deploy netra-auth-service \
  --image gcr.io/netra-staging/auth:latest \
  --platform managed \
  --region us-central1 \
  --project netra-staging \
  --allow-unauthenticated \
  --port 8001 \
  --memory 1Gi \
  --cpu 1 \
  --min-instances 1 \
  --max-instances 2 \
  --set-env-vars ENVIRONMENT=staging \
  --add-cloudsql-instances netra-staging:us-central1:staging-shared-postgres \
  --set-secrets="DATABASE_URL=database-url-staging:latest,JWT_SECRET_KEY=jwt-secret-staging:latest" \
  --timeout 60
      </command>
    </auth_service>
  </working_deployment_commands>

  <critical_requirements>
    <secrets>
      <required>
        - gemini-api-key-staging (MUST exist for backend)
        - database-url-staging (for all services with DB access)
        - jwt-secret-staging (for auth service)
      </required>
      <optional>
        - openai-api-key-staging
        - anthropic-api-key-staging
        - Other LLM provider keys
      </optional>
    </secrets>

    <cloud_sql>
      <instance>staging-shared-postgres</instance>
      <region>us-central1</region>
      <connection_annotation>
        Must include: --add-cloudsql-instances netra-staging:us-central1:staging-shared-postgres
      </connection_annotation>
    </cloud_sql>
  </critical_requirements>

  <deployment_script_issues>
    <issue>
      <problem>deploy-staging-reliable.ps1 had unicode smart quotes causing parsing errors</problem>
      <fix>Replace all smart quotes with regular double quotes</fix>
      <prevention>Always use plain text editors or check for unicode issues</prevention>
    </issue>
  </deployment_script_issues>

  <verification_steps>
    <step order="1">Check service status: gcloud run services list --platform managed --region us-central1</step>
    <step order="2">Verify health endpoint: curl -I https://{service-url}/health</step>
    <step order="3">Check logs for errors: gcloud logging read "resource.type=cloud_run_revision AND severity>=ERROR"</step>
    <step order="4">Verify secrets exist: gcloud secrets list --project netra-staging</step>
  </verification_steps>

  <action_items>
    <item priority="high">Remove duplicate database-url-staging-asyncpg secret</item>
    <item priority="high">Update all deployment scripts to use correct secret names</item>
    <item priority="medium">Consolidate PR branch and main staging deployments</item>
    <item priority="low">Clean up old PR branch databases in Cloud SQL</item>
  </action_items>
</staging_deployment_fixes>