<?xml version="1.0" encoding="UTF-8"?>
<learning>
    <id>docker-service-secret-configuration</id>
    <title>Docker Container Environment Variable Configuration</title>
    <category>docker,configuration,security</category>
    <priority>HIGH</priority>
    <created>2025-08-28</created>
    
    <problem>
        <description>Backend container failing with "Required secrets missing: ['SERVICE_SECRET']" despite value being present in .env file</description>
        <error_message>Required secrets missing: ['SERVICE_SECRET']</error_message>
        <impact>Backend service cannot start, blocking all API functionality</impact>
        <root_cause>Docker containers only see environment variables explicitly passed to them in docker-compose.yml - they don't automatically inherit from .env files</root_cause>
    </problem>
    
    <solution>
        <description>Add missing SERVICE_SECRET to backend service environment variables in docker-compose.dev.yml</description>
        <implementation>
            <file>docker-compose.dev.yml</file>
            <change>
                Added SERVICE_SECRET to backend service environment section:
                ```yaml
                environment:
                  # Security
                  SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production-must-be-at-least-32-chars}
                  JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key-change-in-production-must-be-at-least-32-chars}
                  FERNET_KEY: ${FERNET_KEY:-dev-fernet-key-change-in-production}
                  SERVICE_SECRET: ${SERVICE_SECRET}  # Added this line
                ```
            </change>
        </implementation>
    </solution>
    
    <best_practices>
        <practice>Always ensure all required environment variables are explicitly declared in docker-compose.yml for each service</practice>
        <practice>Docker containers have isolated environments - they don't automatically see host .env files</practice>
        <practice>Use ${VARIABLE_NAME} syntax in docker-compose.yml to reference .env file values</practice>
        <practice>Verify environment variables are available inside containers using: docker exec container_name env | grep VARIABLE</practice>
    </best_practices>
    
    <prevention>
        <step>When adding new required secrets to the application, always update docker-compose.yml files</step>
        <step>Use validation scripts to check all required environment variables are passed to containers</step>
        <step>Document all required environment variables in service documentation</step>
    </prevention>
    
    <verification>
        <command>docker exec netra-backend env | grep SERVICE_SECRET</command>
        <expected_output>SERVICE_SECRET=value_from_env_file</expected_output>
        <health_check>Backend container starts without "Required secrets missing" errors</health_check>
    </verification>
    
    <related_files>
        <file>docker-compose.dev.yml</file>
        <file>.env</file>
        <file>netra_backend/app/core/configuration/secrets.py</file>
    </related_files>
    
    <tags>
        <tag>docker</tag>
        <tag>environment-variables</tag>
        <tag>configuration</tag>
        <tag>security</tag>
        <tag>SERVICE_SECRET</tag>
        <tag>container-isolation</tag>
    </tags>
</learning>