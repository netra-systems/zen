<?xml version="1.0" encoding="UTF-8"?>
<specification>
  <title>Cloud Run Service Naming Convention - CRITICAL</title>
  <version>1.0.0</version>
  <created>2025-08-18</created>
  <priority>CRITICAL</priority>
  
  <overview>
    <description>
      MANDATORY naming convention for Cloud Run services to ensure proper domain mapping.
      These names MUST be used EXACTLY as specified - NO variations allowed.
    </description>
    <importance>
      Domain mapping in GCP Cloud Run requires exact service names. 
      Using incorrect names will break staging/production domain routing.
    </importance>
  </overview>

  <service_names>
    <staging>
      <service name="backend">
        <exact_name>netra-backend-staging</exact_name>
        <domain>api.staging.netrasystems.ai</domain>
        <description>Backend API service for staging environment</description>
        <critical>YES - Must match exactly for domain mapping</critical>
      </service>
      
      <service name="frontend">
        <exact_name>netra-frontend-staging</exact_name>
        <domain>app.staging.netrasystems.ai</domain>
        <description>Frontend web application for staging</description>
        <critical>YES - Must match exactly for domain mapping</critical>
      </service>
      
      <service name="auth">
        <exact_name>netra-auth-service</exact_name>
        <domain>auth.staging.netrasystems.ai</domain>
        <description>Authentication microservice (shared across environments)</description>
        <critical>YES - Must match exactly for auth subdomain</critical>
      </service>
    </staging>
    
    <production>
      <service name="backend">
        <exact_name>netra-backend-prod</exact_name>
        <domain>api.netrasystems.ai</domain>
        <description>Backend API service for production</description>
        <critical>YES - Must match exactly for domain mapping</critical>
      </service>
      
      <service name="frontend">
        <exact_name>netra-frontend-prod</exact_name>
        <domain>app.netrasystems.ai</domain>
        <description>Frontend web application for production</description>
        <critical>YES - Must match exactly for domain mapping</critical>
      </service>
      
      <service name="auth">
        <exact_name>netra-auth-service</exact_name>
        <domain>auth.netrasystems.ai</domain>
        <description>Authentication microservice (shared across environments)</description>
        <critical>YES - Must match exactly for auth subdomain</critical>
      </service>
    </production>
  </service_names>

  <enforcement_rules>
    <rule id="1">
      <description>ALL deployment scripts MUST use these exact names</description>
      <files>
        - deploy_staging_reliable.py
        - terraform-gcp/*.tf
        - .github/workflows/*.yml
        - config/cloudbuild*.yaml
      </files>
    </rule>
    
    <rule id="2">
      <description>Docker image tags should match service names</description>
      <example>
        us-central1-docker.pkg.dev/netra-staging/netra-containers/backend:staging
        -> Deploys to service: netra-backend-staging
      </example>
    </rule>
    
    <rule id="3">
      <description>Environment variables must reference correct service URLs</description>
      <example>
        NEXT_PUBLIC_API_URL=https://api.staging.netrasystems.ai
        (Routes to netra-backend-staging service)
        NEXT_PUBLIC_APP_URL=https://app.staging.netrasystems.ai
        (Routes to netra-frontend-staging service)
      </example>
    </rule>
  </enforcement_rules>

  <common_mistakes>
    <mistake>
      <wrong>netra-backend</wrong>
      <correct>netra-backend-staging</correct>
      <impact>Domain api.staging.netrasystems.ai will not route correctly</impact>
    </mistake>
    
    <mistake>
      <wrong>netra-frontend</wrong>
      <correct>netra-frontend-staging</correct>
      <impact>Domain app.staging.netrasystems.ai will not route correctly</impact>
    </mistake>
    
    <mistake>
      <wrong>netra-auth-staging</wrong>
      <correct>netra-auth-service</correct>
      <impact>Auth service name is consistent across environments</impact>
    </mistake>
  </common_mistakes>

  <deployment_commands>
    <staging>
      <backend>
        gcloud run deploy netra-backend-staging \
          --image us-central1-docker.pkg.dev/netra-staging/netra-containers/backend:staging \
          --platform managed \
          --region us-central1 \
          --project netra-staging
      </backend>
      
      <frontend>
        gcloud run deploy netra-frontend-staging \
          --image us-central1-docker.pkg.dev/netra-staging/netra-containers/frontend:staging \
          --platform managed \
          --region us-central1 \
          --project netra-staging
      </frontend>
      
      <auth>
        gcloud run deploy netra-auth-service \
          --image us-central1-docker.pkg.dev/netra-staging/netra-containers/auth:staging \
          --platform managed \
          --region us-central1 \
          --project netra-staging
      </auth>
    </staging>
  </deployment_commands>

  <verification>
    <command>
      gcloud run services list --platform managed --region us-central1 --project netra-staging
    </command>
    <expected_output>
      netra-backend-staging
      netra-frontend-staging
      netra-auth-service
    </expected_output>
  </verification>
</specification>