<?xml version="1.0" encoding="UTF-8"?>
<spec>
  <metadata>
    <name>Docker Hot Reload Configuration</name>
    <version>1.0.0</version>
    <created>2025-08-29</created>
    <category>development</category>
    <priority>high</priority>
    <tags>docker, development, hot-reload, productivity</tags>
  </metadata>

  <summary>
    Hot reload configuration for Docker-based development enabling instant code updates without container restarts.
    Critical for development velocity - reduces iteration time from 2-3 minutes to under 5 seconds.
  </summary>

  <business_value>
    <segment>Platform/Internal</segment>
    <goal>Development Velocity</goal>
    <impact>10x faster development cycles, enabling rapid MVP iteration</impact>
    <metrics>
      <metric name="code_change_reflection_time">From 120-180s to &lt;5s</metric>
      <metric name="developer_productivity_gain">60-80% reduction in wait time</metric>
    </metrics>
  </business_value>

  <configuration>
    <default_command>
      <!-- ALWAYS use this for local development -->
      <command>docker-compose -f docker-compose.dev.yml up backend auth</command>
      <description>Starts services with hot reload enabled via docker-compose.override.yml</description>
    </default_command>

    <verification>
      <command>python scripts/test_hot_reload.py</command>
      <description>Verifies hot reload is working correctly</description>
    </verification>

    <files_modified>
      <file path="docker-compose.dev.yml">
        <change>Removed :ro (read-only) flags from volume mounts</change>
        <change>Added explicit reload directories for backend and auth</change>
        <change>Enhanced uvicorn reload commands with multiple directories</change>
      </file>
      <file path="docker-compose.override.yml">
        <change>Created override with platform-specific optimizations</change>
        <change>Added polling configuration for Mac/Windows</change>
        <change>Implemented volume mount performance flags</change>
      </file>
    </files_modified>
  </configuration>

  <platform_considerations>
    <platform name="Linux">
      <performance>Native file system events - fastest</performance>
      <special_config>None required</special_config>
      <reload_time>&lt;1 second</reload_time>
    </platform>

    <platform name="Mac">
      <performance>Requires polling due to Docker Desktop limitations</performance>
      <special_config>
        <setting name="WATCHDOG_USE_POLLING">true</setting>
        <setting name="volume_flags">:delegated for write-heavy, :cached for read-heavy</setting>
      </special_config>
      <reload_time>1-2 seconds</reload_time>
      <optimization_options>
        <option>docker-sync for large codebases</option>
        <option>Mutagen for better performance</option>
      </optimization_options>
    </platform>

    <platform name="Windows">
      <performance>WSL2 recommended for best performance</performance>
      <special_config>
        <setting name="WATCHDOG_USE_POLLING">true (if not using WSL2)</setting>
      </special_config>
      <reload_time>1-2 seconds (WSL2), 2-3 seconds (native)</reload_time>
    </platform>
  </platform_considerations>

  <monitored_patterns>
    <pattern>*.py</pattern>
    <pattern>*.json</pattern>
    <pattern>*.yaml</pattern>
    <pattern>*.yml</pattern>
    <excluded>__pycache__</excluded>
    <excluded>*.pyc</excluded>
    <excluded>.pytest_cache</excluded>
  </monitored_patterns>

  <troubleshooting>
    <issue>
      <symptom>Changes not detected on Mac/Windows</symptom>
      <solution>Ensure WATCHDOG_USE_POLLING=true in docker-compose.override.yml</solution>
    </issue>
    <issue>
      <symptom>High CPU usage from polling</symptom>
      <solution>Increase WATCHDOG_POLL_INTERVAL to 2 or use docker-sync/Mutagen</solution>
    </issue>
    <issue>
      <symptom>Permission errors</symptom>
      <solution>Check Docker permissions and file ownership</solution>
    </issue>
  </troubleshooting>

  <learnings>
    <learning date="2025-08-29">
      Read-only volume mounts (:ro) prevent hot reload from working as uvicorn cannot monitor file changes.
      Always remove :ro flags for development volumes that need hot reload.
    </learning>
    <learning date="2025-08-29">
      Docker Desktop on Mac doesn't propagate file system events properly. Polling mode is required
      but increases CPU usage. Trade-off: instant feedback vs resource consumption.
    </learning>
    <learning date="2025-08-29">
      docker-compose.override.yml is automatically loaded and perfect for developer-specific settings
      without modifying the main docker-compose.dev.yml file.
    </learning>
    <learning date="2025-08-29">
      Volume mount performance flags (:cached, :delegated) significantly improve I/O performance
      on Mac but are ignored on Linux where performance is already optimal.
    </learning>
  </learnings>

  <integration_points>
    <integration>
      <component>dev_launcher.py</component>
      <description>Should use hot reload configuration by default</description>
    </integration>
    <integration>
      <component>CI/CD Pipeline</component>
      <description>Should NOT use override file in CI to avoid polling overhead</description>
    </integration>
  </integration_points>

  <related_specs>
    <spec>gcp_deployment.xml</spec>
    <spec>deployment_architecture.xml</spec>
    <spec>dev_launcher.xml</spec>
  </related_specs>

  <documentation>
    <doc path="docs/docker-hot-reload-guide.md">Comprehensive setup and usage guide</doc>
    <doc path="scripts/test_hot_reload.py">Automated verification script</doc>
  </documentation>
</spec>