<?xml version="1.0" encoding="UTF-8"?>
<specification>
  <metadata>
    <name>Development.AntiRegressionProtocol</name>
    <type>InstructionSet</type>
    <version>2.0.0</version>
    <description>Critical instructions for AI agents to prevent the reintroduction of known bugs.</description>
  </metadata>

  <core-directives>
    <directive id="AR-D1">
      <title>Prioritize Clarity Over Assumption</title>
      <instruction>If the user prompt is ambiguous, DO NOT proceed with assumptions. Immediately request clarification.</instruction>
    </directive>
    <directive id="AR-D3">
      <title>Conservation of Functional Code</title>
      <instruction>Do not modify existing, functional code unless explicitly requested or required for compliance (e.g., 300/8 rule). Unsolicited refactoring is forbidden.</instruction>
    </directive>
  </core-directives>

  <known-regression-patterns>
    <pattern id="KRP-001" context="Frontend/Zustand">
      <name>Zustand Selector Infinite Loop</name>
      <prevention-protocol>
        <step>Use individual selectors for each state property.</step>
        <step>NEVER return a newly created object from a selector.</step>
      </prevention-protocol>
    </pattern>

    <pattern id="KRP-002" context="Project Structure">
      <name>Unnecessary File Proliferation</name>
      <prevention-protocol>
        <step>ALWAYS prioritize modifying existing files.</step>
        <step>Do not create new documentation (.md) or example files unless explicitly requested.</step>
      </prevention-protocol>
    </pattern>

    <pattern id="KRP-004" context="Testing">
      <name>Test Suite Corruption</name>
      <prevention-protocol>
        <step>NEVER modify test assertions to make them pass.</step>
        <step>Fix the System Under Test (SUT), not the test.</step>
      </prevention-protocol>
    </pattern>

    <pattern id="KRP-005" context="Backend/ClickHouse">
      <name>ClickHouse Array Syntax Error</name>
      <prevention-protocol>
        <step>MANDATORY: Use `arrayElement(array, index)`.</step>
        <step>FORBIDDEN: Use SQL-style `array[index]` syntax.</step>
        <step>MANDATORY: Preserve exact casing of ClickHouse functions. Do not lowercase queries.</step>
      </prevention-protocol>
    </pattern>

     <pattern id="KRP-006" context="Frontend/React">
      <name>React Key Instability</name>
      <prevention-protocol>
        <step>Use stable, unique identifiers or `generateUniqueId()` from `@/lib/utils`.</step>
        <step>FORBIDDEN: Using array indices, `Date.now()`, or `Math.random()` as keys.</step>
      </prevention-protocol>
    </pattern>
  </known-regression-patterns>

  <ambiguity-resolution-protocol>
    <title>Handling Ambiguous Prompts</title>
    <scenario keyword="refactor, improve, optimize">
      <action>Request specific scope (files/functions) and goals (performance/compliance). Do NOT proceed with broad changes to working code.</action>
    </scenario>
    <scenario keyword="document, explain">
      <action>Prefer updating existing SPEC/ XML files or in-code docstrings. Do NOT create new standalone files unless specified.</action>
    </scenario>
  </ambiguity-resolution-protocol>
</specification>