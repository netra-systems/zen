<?xml version="1.0" encoding="UTF-8"?>
<spec>
  <name>Test Reporting System</name>
  <version>2.0</version>
  <status>active</status>
  <description>
    Comprehensive test reporting system specification that ensures clear, accurate, and persistent test tracking.
  </description>

  <critical-requirements>
    <requirement>
      <id>TR-001</id>
      <priority>CRITICAL</priority>
      <description>All test categories MUST be tracked persistently</description>
      <rationale>Test counts should remain visible even when collection fails</rationale>
    </requirement>
    
    <requirement>
      <id>TR-002</id>
      <priority>CRITICAL</priority>
      <description>Report ALL known test levels and categories</description>
      <rationale>Users need complete visibility into all available test categories</rationale>
      <known-levels>
        smoke, unit, agents, integration, critical,
        comprehensive, comprehensive-backend, comprehensive-frontend,
        comprehensive-core, comprehensive-agents, comprehensive-websocket,
        comprehensive-database, comprehensive-api, all,
        real_e2e, real_services, mock_only
      </known-levels>
    </requirement>
    
    <requirement>
      <id>TR-003</id>
      <priority>HIGH</priority>
      <description>Clear distinction between status states</description>
      <states>
        <state icon="✅" name="passed">All tests passed</state>
        <state icon="❌" name="failed">Tests failed</state>
        <state icon="⚫" name="collection_failed">Test collection failed</state>
        <state icon="🔴" name="import_error">Import errors prevent tests</state>
        <state icon="⚠️" name="warning">Non-critical issues</state>
      </states>
    </requirement>
  </critical-requirements>

  <reporting-structure>
    <report-files>
      <file>
        <path>test_reports/dashboard.md</path>
        <purpose>Main dashboard with all components and categories</purpose>
        <sections>
          <section>Overall Status</section>
          <section>Component Summary (Backend, Frontend, E2E)</section>
          <section>Test Categories (All known categories)</section>
          <section>Issues Detected</section>
          <section>Statistics</section>
          <section>Available Test Levels</section>
          <section>Quick Actions</section>
        </sections>
      </file>
      
      <file>
        <path>test_reports/summary.md</path>
        <purpose>Concise summary of test results</purpose>
        <sections>
          <section>Status</section>
          <section>Component Summaries</section>
          <section>Issues</section>
        </sections>
      </file>
      
      <file>
        <path>test_reports/test_state.json</path>
        <purpose>Persistent test state tracking</purpose>
        <data>
          <field>known_tests</field>
          <field>last_successful_counts</field>
          <field>category_status</field>
          <field>last_update</field>
        </data>
      </file>
      
      <file>
        <path>test_reports/test_history.json</path>
        <purpose>Historical test runs (last 50)</purpose>
      </file>
    </report-files>
  </reporting-structure>

  <implementation>
    <module>
      <name>comprehensive_reporter.py</name>
      <location>test_framework/comprehensive_reporter.py</location>
      <responsibilities>
        <responsibility>Generate comprehensive dashboards</responsibility>
        <responsibility>Track persistent test state</responsibility>
        <responsibility>Maintain test history</responsibility>
        <responsibility>Show all known categories</responsibility>
      </responsibilities>
    </module>
    
    <module>
      <name>report_manager.py</name>
      <location>test_framework/report_manager.py</location>
      <responsibilities>
        <responsibility>Coordinate multiple reporters</responsibility>
        <responsibility>Save reports to disk</responsibility>
        <responsibility>Print summaries</responsibility>
      </responsibilities>
    </module>
    
    <module>
      <name>runner.py</name>
      <location>test_framework/runner.py</location>
      <responsibilities>
        <responsibility>Initialize comprehensive reporter</responsibility>
        <responsibility>Trigger report generation</responsibility>
      </responsibilities>
    </module>
  </implementation>

  <anti-patterns>
    <anti-pattern>
      <name>Missing Categories</name>
      <description>Never hide test categories that exist</description>
      <solution>Always show all known categories, even with 0 tests</solution>
    </anti-pattern>
    
    <anti-pattern>
      <name>Lost Test Counts</name>
      <description>Test counts disappearing when collection fails</description>
      <solution>Persist last known successful counts</solution>
    </anti-pattern>
    
    <anti-pattern>
      <name>Confusing Status</name>
      <description>Unclear or ambiguous test status reporting</description>
      <solution>Use clear icons and explicit status messages</solution>
    </anti-pattern>
    
    <anti-pattern>
      <name>Legacy Artifacts</name>
      <description>Multiple conflicting report formats</description>
      <solution>Single comprehensive reporter as source of truth</solution>
    </anti-pattern>
  </anti-patterns>

  <testing>
    <test-case>
      <name>All categories visible</name>
      <verify>Dashboard shows all 17+ test levels</verify>
    </test-case>
    
    <test-case>
      <name>Persistent counts</name>
      <verify>Test counts remain after collection failure</verify>
    </test-case>
    
    <test-case>
      <name>Clear status icons</name>
      <verify>Each status has distinct icon and message</verify>
    </test-case>
    
    <test-case>
      <name>History tracking</name>
      <verify>Last 50 test runs are preserved</verify>
    </test-case>
  </testing>

  <learnings>
    <learning date="2025-08-17">
      Enhanced reporter was causing confusion with missing categories.
      Solution: Created comprehensive_reporter.py with all known categories.
    </learning>
    
    <learning date="2025-08-17">
      Test counts were disappearing on collection failures.
      Solution: Added persistent test_state.json tracking.
    </learning>
    
    <learning date="2025-08-17">
      Multiple report formats were creating legacy artifacts.
      Solution: Unified under comprehensive_reporter as single source of truth.
    </learning>
  </learnings>
</spec>