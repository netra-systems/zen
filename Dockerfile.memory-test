FROM netra-pytest-optimized:latest

# Add memory test script
RUN cat > /app/docker_memory_test.py << 'SCRIPT'
#!/usr/bin/env python3
import psutil
import time
import sys
import gc

def get_memory_info():
    process = psutil.Process()
    mem_info = process.memory_info()
    return {
        'rss_mb': mem_info.rss / (1024 * 1024),
        'percent': psutil.virtual_memory().percent
    }

print("=== DOCKER PYTEST MEMORY TEST ===\n")

# Test 1: Baseline memory
print("1. Baseline Memory Usage:")
baseline = get_memory_info()
print(f"   RSS: {baseline['rss_mb']:.1f} MB")
print(f"   System: {baseline['percent']:.1f}%")

# Test 2: Import pytest
print("\n2. After importing pytest:")
import pytest
after_pytest = get_memory_info()
print(f"   RSS: {after_pytest['rss_mb']:.1f} MB (+{after_pytest['rss_mb'] - baseline['rss_mb']:.1f} MB)")

# Test 3: Simulated collection
print("\n3. Simulating test collection (1000 tests):")
test_objects = []
for i in range(1000):
    test_objects.append({
        'name': f'test_{i}',
        'fixtures': ['fixture_a', 'fixture_b'],
        'markers': ['unit', 'fast']
    })
after_collection = get_memory_info()
print(f"   RSS: {after_collection['rss_mb']:.1f} MB (+{after_collection['rss_mb'] - after_pytest['rss_mb']:.1f} MB)")

# Test 4: Cleanup
print("\n4. After cleanup and GC:")
test_objects.clear()
gc.collect()
time.sleep(0.5)
after_cleanup = get_memory_info()
print(f"   RSS: {after_cleanup['rss_mb']:.1f} MB (recovered {after_collection['rss_mb'] - after_cleanup['rss_mb']:.1f} MB)")

# Summary
print("\n=== SUMMARY ===")
print(f"Peak memory: {max(baseline['rss_mb'], after_pytest['rss_mb'], after_collection['rss_mb']):.1f} MB")
print(f"Final memory: {after_cleanup['rss_mb']:.1f} MB")

if after_cleanup['rss_mb'] < 256:
    print(f"\n✅ PASS: Memory under 256MB limit")
else:
    print(f"\n❌ FAIL: Memory exceeds limit")
    sys.exit(1)
SCRIPT

CMD ["python", "/app/docker_memory_test.py"]
