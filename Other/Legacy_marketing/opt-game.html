<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Supply Game v14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117; --text-color: #c9d1d9; --primary-color: #58a6ff;
            --secondary-color: #f778ba; --success-color: #3fb950; --fail-color: #f85149;
            --warn-color: #d29922; --log-bg: #161b22; --apex-active-color: #bc8cff;
            --border-color: #30363d; --card-bg: #161b22;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        
        .modal { transition: opacity 0.3s ease, visibility 0.3s; }
        .modal.open { opacity: 1; visibility: visible; }
        .modal.open > div { transform: scale(1); }

        .game-over-fade { filter: blur(4px); opacity: 0.6; transform: scale(0.98); transition: all 0.5s ease; }

        .workload { transition: all 0.3s ease; cursor: pointer; border: 2px solid var(--border-color); }
        .workload.selected { transform: scale(1.05); border-color: var(--primary-color); box-shadow: 0 0 15px rgba(88, 166, 255, 0.4); }
        .workload.apex-claimed { border-color: var(--apex-active-color); animation: pulse-apex-claim 1s; }
        @keyframes pulse-apex-claim { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .model-card { border: 2px solid var(--border-color); transition: all 0.3s ease; }
        .model-card.selectable:hover { border-color: var(--primary-color); transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .model-card.processing { border-color: var(--secondary-color); animation: pulse-processing 1.5s infinite; }
        .model-card.disabled { opacity: 0.5; background-color: #21262d; cursor: not-allowed; }
        @keyframes pulse-processing { 0%, 100% { box-shadow: 0 0 10px transparent; } 50% { box-shadow: 0 0 10px var(--secondary-color); } }

        #news-feed-container { scroll-behavior: smooth; }
        #news-feed-container p { animation: fadeIn 0.5s ease; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom color classes for Tailwind */
        .text-success-color { color: var(--success-color); }
        .text-fail-color { color: var(--fail-color); }
        .text-warn-color { color: var(--warn-color); }
        .text-secondary-color { color: var(--secondary-color); }
        .text-apex-active-color { color: var(--apex-active-color); }
        .bg-apex-active-color { background-color: var(--apex-active-color); }
        .bg-apex-active-color:hover { background-color: #a370f7; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--log-bg); }
        ::-webkit-scrollbar-thumb { background: #484f58; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #586069; }
    </style>
</head>
<body class="flex flex-col items-center justify-between min-h-screen p-2 sm:p-4">
    <div id="game-container" class="w-full max-w-screen-xl mx-auto z-10 transition-all duration-500">
        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-6 items-start">
            <!-- Left Panel: Workloads & Metrics -->
            <div class="lg:col-span-3 flex flex-col gap-4">
                <div class="bg-card-bg p-4 rounded-lg border border-border-color w-full">
                    <h2 class="text-lg font-bold text-gray-200 mb-2">Incoming User Requests</h2>
                    <div id="workload-queue" class="h-28 bg-log-bg p-2 rounded-md flex items-center gap-3 overflow-x-auto border border-border-color">
                        <p class="text-gray-500 w-full text-center">No pending requests...</p>
                    </div>
                </div>
                <div class="bg-card-bg p-4 rounded-lg border border-border-color w-full">
                    <h2 class="text-xl font-bold text-gray-200 mb-3 text-center">Core KPIs</h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center text-md"><span class="font-semibold text-gray-400">Time Remaining:</span><span id="timer" class="font-bold text-primary-color">150s</span></div>
                            <div class="w-full bg-log-bg rounded-full h-2.5 mt-1"><div id="timer-bar" class="bg-primary-color h-2.5 rounded-full" style="width: 100%"></div></div>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-400 text-md">User Experience (UX) Score:</label>
                            <div class="w-full bg-log-bg rounded-full h-4 mt-1 border border-border-color"><div id="health-bar" class="bg-success-color h-full rounded-full transition-all duration-500" style="width: 100%"></div></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center border-t border-border-color pt-3">
                            <div><label class="font-semibold text-gray-400 text-sm">Simulated Burn</label><p id="op-cost" class="text-xl font-bold text-gray-300">$0.0k</p></div>
                            <div><label class="font-semibold text-gray-400 text-sm">Cost/Perf Index</label><p id="efficiency" class="text-xl font-bold text-gray-300">100%</p></div>
                            <div><label class="font-semibold text-gray-400 text-sm">Request Queue</label><p id="queue-length" class="text-xl font-bold text-gray-300">0</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Apex & Supply Options -->
            <div class="lg:col-span-5 flex flex-col gap-4">
                 <div class="bg-card-bg p-4 rounded-lg border border-border-color w-full">
                     <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold text-apex-active-color">Netra Apex™ Control</h2>
                        <div class="flex items-center gap-2">
                            <span id="apex-status-light" class="w-3 h-3 rounded-full bg-gray-600 transition-colors"></span>
                            <span id="apex-status-text" class="font-semibold text-gray-500 text-sm">DISABLED</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2 mb-4">Automate your routing logic to protect UX, control burn, and free up engineering resources.</p>
                    <div class="flex flex-col sm:flex-row gap-2">
                         <button id="toggle-apex-btn" class="flex-grow bg-apex-active-color text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Enable Apex</button>
                        <select id="apex-utility-function" class="bg-log-bg border border-border-color rounded-lg p-2 text-gray-300 text-sm">
                            <option value="balanced">Goal: Balanced</option>
                            <option value="cost">Goal: Minimize Burn</option>
                            <option value="latency">Goal: Max Speed</option>
                            <option value="quality">Goal: Max Quality</option>
                        </select>
                    </div>
                </div>
                 <h2 class="text-xl font-bold text-gray-200 text-center -mb-2">Supply Options</h2>
                 <div class="bg-card-bg p-3 rounded-lg border border-border-color">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                        <input type="text" id="filter-name" placeholder="Filter by name..." class="bg-log-bg border border-border-color rounded-md p-1.5 placeholder-gray-500 text-gray-300">
                        <select id="filter-provider" class="bg-log-bg border border-border-color rounded-md p-1.5 text-gray-300"><option value="">All Providers</option></select>
                        <select id="filter-region" class="bg-log-bg border border-border-color rounded-md p-1.5 text-gray-300"><option value="">All Regions</option></select>
                        <select id="sort-by" class="bg-log-bg border border-border-color rounded-md p-1.5 text-gray-300">
                            <option value="cost">Sort by Cost</option>
                            <option value="quality">Sort by Quality</option>
                            <option value="latency">Sort by Latency</option>
                        </select>
                    </div>
                 </div>
                 <div id="models-container" class="space-y-2 h-[48vh] overflow-y-auto pr-2">
                     <!-- Models are dynamically generated here -->
                 </div>
            </div>

            <!-- Right Panel: News Feed -->
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="bg-card-bg p-4 rounded-lg border border-border-color w-full h-[75vh]">
                     <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold text-gray-200">Market & News Feed</h2>
                        <select id="sort-news" class="bg-log-bg border border-border-color rounded-md p-1 text-xs text-gray-300">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                     <div id="news-feed-container" class="h-full overflow-y-auto text-sm pr-2"></div>
                 </div>
            </div>
        </main>
    </div>
    
    <footer class="text-center py-4">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-200 opacity-0">AI Supply Game</h1>
        <p class="text-sm text-gray-400 mt-1 opacity-0">Tame your unpredictable LLM spend and deliver a world-class user experience.</p>
    </footer>

    <!-- Modals -->
    <div id="game-over-modal" class="modal fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 opacity-0 invisible">
        <div class="bg-card-bg border border-fail-color rounded-2xl p-8 text-center max-w-lg transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-bold text-fail-color mb-4">UX Score Collapsed!</h2>
            <p class="text-md text-gray-400 mb-6">High latency and poor quality responses led to user churn. Your monthly burn was not sustainable for the results.</p>
            <p id="final-stats-loss" class="text-gray-400 mb-6"></p>
            <button onclick="resetGame()" class="bg-fail-color hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Restart Simulation</button>
        </div>
    </div>
     <div id="win-modal" class="modal fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 opacity-0 invisible">
        <div class="bg-card-bg border border-success-color rounded-2xl p-8 text-center max-w-lg transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-bold text-success-color mb-4">Supply Chain Optimized!</h2>
            <p class="text-md text-gray-400 mb-6">You achieved predictable spend and a best-in-class user experience. Your board is pleased.</p>
            <p id="final-stats-win" class="text-gray-400 mb-6"></p>
            <button onclick="resetGame()" class="bg-success-color hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Run Again</button>
        </div>
    </div>

    <script>
        // --- Constants and Config ---
        const GAME_DURATION = 150;
        const BURN_SCALING_FACTOR = 5000; // Each workload represents this many real requests for cost calculation
        const WORKLOAD_ICONS = ['💬', '🌐', '💻', '📚', '🎵', '🖼️', '📊', '🔍', '📝', '💡', '⚖️', '🤖'];
        const WORKLOAD_NAMES = ['Onboarding Chat', 'Translate Copy', 'Feature Copilot', 'RAG Doc Search', 'Audio Transcription', 'Image Analysis', 'BI Dashboard', 'Semantic Search', 'Summarize Transcript', 'Generate Ideas', 'Legal Review', 'Agentic Task'];
        const WORKLOAD_BASE_TYPES = {
            Chat: { qualityReq: 0.4, latencyReq: 300, baseValue: 100, size: 1000 }, // size is in tokens
            Translate: { qualityReq: 0.7, latencyReq: 1000, baseValue: 500, size: 2500 },
            Code: { qualityReq: 0.8, latencyReq: 3000, baseValue: 1500, size: 4000 },
            RAG: { qualityReq: 0.9, latencyReq: 5000, baseValue: 4000, size: 8000 },
        };
        const PROVIDERS = ['OpenAI', 'Anthropic', 'Google', 'Mistral', 'Meta', 'Groq'];
        const REGIONS = ['us-east-1', 'us-west-2', 'eu-central-1', 'ap-southeast-1'];
        const MODEL_NAMES = ['GPT-4o', 'Claude-3', 'Gemini-1.5', 'Llama-3', 'Mixtral', 'GPT-3.5-Turbo'];
        const SPECIALIZATIONS = ['Chat', 'Code', 'Translate', 'General'];

        // --- Game State ---
        let gameState, models, baseModels, workloadQueue, selectedWorkload, gameLoop, workloadInterval, newsInterval, newsArchive;

        // --- DOM Elements ---
        const getEl = id => document.getElementById(id);
        const timerText = getEl('timer');
        const timerBar = getEl('timer-bar');
        const healthBar = getEl('health-bar');
        const opCostText = getEl('op-cost');
        const efficiencyText = getEl('efficiency');
        const queueLengthText = getEl('queue-length');
        const workloadQueueDiv = getEl('workload-queue');
        const modelsContainer = getEl('models-container');
        const toggleApexBtn = getEl('toggle-apex-btn');
        const apexStatusLight = getEl('apex-status-light');
        const apexStatusText = getEl('apex-status-text');
        const apexUtilitySelect = getEl('apex-utility-function');
        const newsFeedContainer = getEl('news-feed-container');
        const sortNewsSelect = getEl('sort-news');

        // --- Core Game Logic ---
        function generateBaseModels() {
            const generatedModels = {};
            for (let i = 0; i < 30; i++) {
                const name = `${MODEL_NAMES[i % MODEL_NAMES.length]}-${i+1}`;
                const provider = PROVIDERS[i % PROVIDERS.length];
                const quality = 0.4 + Math.random() * 0.6; // 0.4 to 1.0
                // Cost in dollars per 1 Million tokens. Quality is a big factor.
                const cost = 0.5 + quality * 4 + Math.random() * 2; // e.g., $0.5 to ~$6.5 per 1M
                const latency = 100 + (1 - quality) * 2000 + Math.random() * 500;
                const throughput = 400 + quality * 600 + Math.random() * 200;
                const contextWindow = 2 ** (Math.floor(Math.random() * 5) + 10); // 1k to 32k
                
                generatedModels[name] = {
                    name, provider, cost, latency, quality, throughput, contextWindow,
                    region: REGIONS[i % REGIONS.length],
                    tunedFor: SPECIALIZATIONS[i % SPECIALIZATIONS.length],
                    disabled: false,
                };
            }
            return generatedModels;
        }

        function initializeGame() {
            baseModels = generateBaseModels();
            models = JSON.parse(JSON.stringify(baseModels));
            gameState = {
                timeLeft: GAME_DURATION,
                customerHealth: 100,
                opCost: 0,
                totalEfficiencyScore: 0,
                tasksCompleted: 0,
                isApexEnabled: false,
                isGameOver: false,
            };
            workloadQueue = [];
            selectedWorkload = null;
            newsArchive = [];
            
            logNews("Welcome, Manager. Your goal is to maintain a high UX Score while managing your burn. Manually route requests by clicking a workload, then a supply option.", 'info');
            
            const providerFilter = getEl('filter-provider');
            if (providerFilter.options.length <= 1) {
                PROVIDERS.forEach(p => providerFilter.innerHTML += `<option value="${p}">${p}</option>`);
            }
            const regionFilter = getEl('filter-region');
            if (regionFilter.options.length <= 1) {
                 REGIONS.forEach(r => regionFilter.innerHTML += `<option value="${r}">${r}</option>`);
            }
        }

        function gameTick() {
            if (gameState.isGameOver) return;

            if (gameState.isApexEnabled && workloadQueue.length > 0) {
                const availableModel = Object.values(models).some(m => !m.processing && !m.disabled);
                if (availableModel) apexTick();
            }
            
            if (workloadQueue.length > 4) {
                updateHealth(-(workloadQueue.length - 4) * 0.1, "High queue times impacting UX");
            }
            
            if (gameState.isApexEnabled && gameState.customerHealth < 100) {
                updateHealth(0.05, "Apex system optimization");
            }

            gameState.timeLeft -= 1 / 20;
            if (gameState.timeLeft <= 0) {
                endGame(true);
                return;
            }

            updateMetricsUI();
        }

        function apexTick() {
            const workloadDiv = workloadQueueDiv.children[0];
            if (!workloadDiv || workloadDiv.classList.contains('apex-claimed')) return;

            workloadDiv.classList.add('apex-claimed');
            
            setTimeout(() => {
                if (gameState.isGameOver) return;
                const workload = workloadQueue[0];
                if (!workload) return;

                const utility = apexUtilitySelect.value;
                let bestModelName = null;
                let bestScore = -Infinity;

                Object.values(models).forEach(model => {
                    if (model.processing || model.disabled) return;
                    let score = 0;
                    const costScore = 100 - (model.cost * 10);
                    const latencyScore = 100 - (model.latency / 30);
                    const qualityScore = model.quality * 100;

                    switch (utility) {
                        case 'cost': score = costScore * 2 - latencyScore - qualityScore; break;
                        case 'latency': score = latencyScore * 2 - costScore - qualityScore; break;
                        case 'quality': score = qualityScore * 2 - costScore - latencyScore; break;
                        case 'balanced': score = costScore + latencyScore + qualityScore; break;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestModelName = model.name;
                    }
                });

                if (bestModelName) {
                    routeWorkload(0, bestModelName, true);
                } else {
                     workloadDiv.classList.remove('apex-claimed');
                }
            }, 500);
        }

        function generateWorkload() {
            if (gameState.isGameOver || workloadQueue.length > 10) return;
            const workloadIndex = Math.floor(Math.random() * WORKLOAD_NAMES.length);
            const name = WORKLOAD_NAMES[workloadIndex];
            const icon = WORKLOAD_ICONS[workloadIndex];
            const baseTypeKey = Object.keys(WORKLOAD_BASE_TYPES)[workloadIndex % Object.keys(WORKLOAD_BASE_TYPES).length];
            const baseType = WORKLOAD_BASE_TYPES[baseTypeKey];
            
            workloadQueue.push({ ...baseType, name, icon, id: Date.now() + Math.random() });
            updateWorkloadQueueUI();
        }

        function routeWorkload(workloadIndex, modelName, isApex) {
            const workload = workloadQueue.splice(workloadIndex, 1)[0];
            const model = models[modelName];

            if (!workload || !model || model.processing || model.disabled) return;
            
            selectedWorkload = null;
            model.processing = workload;
            
            const processingTime = (workload.size / model.throughput) * 1000 + model.latency;
            
            setTimeout(() => {
                if (gameState.isGameOver) return;
                
                // Cost is based on $/1M tokens, scaled up for simulation
                const cost = (workload.size / 1_000_000) * model.cost * BURN_SCALING_FACTOR;
                gameState.opCost += cost;

                const qualityDiff = model.quality - workload.qualityReq;
                if (qualityDiff < -0.1) updateHealth(-5, `${workload.name} failed quality check`);
                
                const latencyDiff = workload.latencyReq - processingTime;
                if (latencyDiff < 0) updateHealth(-3, `${workload.name} was too slow`);
                
                const contextDiff = model.contextWindow * 1024 - workload.size;
                if (contextDiff < 0) updateHealth(-10, `${workload.name} exceeded context window`);

                if (qualityDiff >= -0.1 && latencyDiff >= 0 && contextDiff >= 0) updateHealth(1, "Good service");

                const qualityMatch = Math.min(1, model.quality / workload.qualityReq);
                const latencyMatch = Math.max(0, Math.min(1, workload.latencyReq / processingTime));
                let efficiency = (qualityMatch + latencyMatch) / 2 * 100;
                if (model.tunedFor === workload.name) efficiency *= 1.2;
                
                gameState.tasksCompleted++;
                gameState.totalEfficiencyScore += efficiency;

                model.processing = null;
                updateModelsUI();
            }, processingTime);

            updateWorkloadQueueUI();
            updateModelsUI();
        }

        function updateHealth(change, reason) {
            if (gameState.isGameOver) return;
            if (gameState.isApexEnabled && change < 0) {
                change *= 0.2; // Apex mitigates some UX damage
            }
            const newHealth = gameState.customerHealth + change;
            gameState.customerHealth = Math.min(100, Math.max(0, newHealth));
            
            if (gameState.customerHealth <= 0 && !gameState.isApexEnabled) {
                endGame(false);
            }
        }

        // --- UI Update Functions ---
        function updateMetricsUI() {
            timerText.textContent = `${Math.ceil(gameState.timeLeft)}s`;
            timerBar.style.width = `${(gameState.timeLeft / GAME_DURATION) * 100}%`;
            healthBar.style.width = `${gameState.customerHealth}%`;
            healthBar.style.backgroundColor = gameState.customerHealth > 60 ? 'var(--success-color)' : gameState.customerHealth > 30 ? 'var(--warn-color)' : 'var(--fail-color)';
            opCostText.textContent = `$${(gameState.opCost / 1000).toFixed(1)}k`;
            const avgEfficiency = gameState.tasksCompleted > 0 ? gameState.totalEfficiencyScore / gameState.tasksCompleted : 100;
            efficiencyText.textContent = `${Math.round(avgEfficiency)}%`;
            efficiencyText.style.color = avgEfficiency > 95 ? 'var(--success-color)' : avgEfficiency > 70 ? 'var(--warn-color)' : 'var(--fail-color)';
            queueLengthText.textContent = workloadQueue.length;
        }

        function updateWorkloadQueueUI() {
            workloadQueueDiv.innerHTML = '';
            if (workloadQueue.length === 0) {
                workloadQueueDiv.innerHTML = `<p class="text-gray-500 w-full text-center">No pending requests...</p>`;
                return;
            }
            workloadQueue.forEach((workload, index) => {
                const div = document.createElement('div');
                div.className = `workload bg-card-bg p-2 rounded-lg text-2xl flex-shrink-0 flex items-center justify-center w-16 h-16 ${selectedWorkload === index ? 'selected' : ''}`;
                div.textContent = workload.icon;
                div.title = `${workload.name}\nQuality Req: ${workload.qualityReq.toFixed(2)}\nLatency Req: ${workload.latencyReq}ms`;
                if (!gameState.isApexEnabled) {
                    div.onclick = () => {
                        selectedWorkload = selectedWorkload === index ? null : index;
                        updateWorkloadQueueUI();
                        updateModelsUI();
                    };
                }
                workloadQueueDiv.appendChild(div);
            });
        }

        function updateModelsUI() {
            modelsContainer.innerHTML = '';
            const nameFilter = getEl('filter-name').value.toLowerCase();
            const providerFilter = getEl('filter-provider').value;
            const regionFilter = getEl('filter-region').value;
            const sortBy = getEl('sort-by').value;

            let filteredModels = Object.values(models).filter(m => 
                m.name.toLowerCase().includes(nameFilter) &&
                (providerFilter === '' || m.provider === providerFilter) &&
                (regionFilter === '' || m.region === regionFilter)
            );

            filteredModels.sort((a,b) => {
                if (sortBy === 'cost') return a.cost - b.cost;
                if (sortBy === 'quality') return b.quality - a.quality;
                if (sortBy === 'latency') return a.latency - b.latency;
                return 0;
            });

            filteredModels.forEach(model => {
                const isSelectable = selectedWorkload !== null && !model.processing && !model.disabled;
                const card = document.createElement('div');
                card.className = `model-card bg-card-bg p-3 rounded-lg ${isSelectable ? 'selectable' : ''} ${model.processing ? 'processing' : ''} ${model.disabled ? 'disabled' : ''}`;
                if (isSelectable) {
                    card.onclick = () => routeWorkload(selectedWorkload, model.name, false);
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-md font-bold ${model.disabled ? 'text-gray-600' : 'text-gray-200'}">${model.name}</h3>
                            <p class="text-xs font-medium text-gray-500">${model.provider}</p>
                        </div>
                        <p class="text-xs font-semibold px-2 py-1 rounded-full ${model.disabled ? 'bg-gray-700 text-gray-400' : 'bg-log-bg text-gray-300'}">${model.region}</p>
                    </div>
                    ${model.disabled ? `<div class="flex items-center justify-center h-24"><p class="font-bold text-fail-color">OFFLINE</p></div>` : model.processing ? `<div class="flex items-center justify-center h-24"><p class="font-bold text-secondary-color">Processing ${model.processing.icon}</p></div>` : `
                    <div class="grid grid-cols-3 gap-2 mt-3 text-center border-t border-border-color pt-2">
                        <div><p class="text-xs text-gray-500">Cost/M Tok</p><p class="font-semibold text-sm text-gray-300">$${model.cost.toFixed(2)}</p></div>
                        <div><p class="text-xs text-gray-500">Quality</p><p class="font-semibold text-sm text-gray-300">${(model.quality * 100).toFixed(0)}</p></div>
                        <div><p class="text-xs text-gray-500">Latency</p><p class="font-semibold text-sm text-gray-300">${Math.round(model.latency)}ms</p></div>
                        <div><p class="text-xs text-gray-500">Context</p><p class="font-semibold text-sm text-gray-300">${Math.floor(model.contextWindow/1024)}k</p></div>
                        <div class="col-span-2"><p class="text-xs text-gray-500">Tuned For</p><p class="font-semibold text-sm text-gray-300">${model.tunedFor}</p></div>
                    </div>`}
                `;
                modelsContainer.appendChild(card);
            });
        }
        
        function logNews(message, type) {
            newsArchive.push({ message, type, time: gameState.timeLeft });
            renderNewsFeed();
        }

        function renderNewsFeed() {
            newsFeedContainer.innerHTML = '';
            const sortOrder = sortNewsSelect.value;
            
            const sortedNews = [...newsArchive].sort((a, b) => {
                return sortOrder === 'newest' ? b.time - a.time : a.time - b.time;
            });

            const colors = { info: 'text-gray-400', warn: 'text-warn-color', good: 'text-success-color', bad: 'text-fail-color' };
            sortedNews.forEach(newsItem => {
                const p = document.createElement('p');
                p.className = `font-medium ${colors[newsItem.type] || 'text-gray-400'}`;
                p.innerHTML = `<span class="font-bold">[T-${Math.ceil(newsItem.time)}s]</span> ${newsItem.message}`;
                newsFeedContainer.appendChild(p);
            });
        }

        function triggerNewsEvent() {
            if (gameState.isGameOver) return;
            const targetProvider = PROVIDERS[Math.floor(Math.random() * PROVIDERS.length)];
            const targetRegion = REGIONS[Math.floor(Math.random() * REGIONS.length)];
            const EVENTS = [
                { text: `Price Hike: ${targetProvider} doubles prices due to high demand.`, type: 'bad', effect: () => Object.values(models).filter(m=>m.provider===targetProvider).forEach(m=>m.cost*=2) },
                { text: `Performance Boost: ${targetProvider} rolls out an update, decreasing latency by 50%!`, type: 'good', effect: () => Object.values(models).filter(m=>m.provider===targetProvider).forEach(m=>m.latency*=0.5) },
                { text: `New Llama-3 model released, forcing ${targetProvider} to cut prices by 40%.`, type: 'good', effect: () => Object.values(models).filter(m=>m.provider===targetProvider).forEach(m=>m.cost*=0.6) },
                { text: `Bad Training Run: All ${targetProvider} models suffer reduced quality.`, type: 'bad', effect: () => Object.values(models).filter(m=>m.provider===targetProvider).forEach(m=>m.quality*=0.8) },
                { text: `Security Alert: ${targetProvider} is offline for patching.`, type: 'bad', effect: () => Object.values(models).filter(m=>m.provider===targetProvider).forEach(m=>m.disabled=true) },
                { text: `Regional Outage: A fiber cut in ${targetRegion} is causing high latency.`, type: 'bad', effect: () => Object.values(models).filter(m=>m.region===targetRegion).forEach(m=>m.latency*=3) },
                { text: `Demand Shift: A viral new feature is causing a surge in Code Gen tasks.`, type: 'warn', effect: () => { for(let i=0; i<3; i++) workloadQueue.push({ ...WORKLOAD_BASE_TYPES.Code, name: 'Code Gen', icon: '💻', id: Date.now() + Math.random() + i }); updateWorkloadQueueUI(); } },
            ];
            const event = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            
            logNews(event.text, event.type);
            event.effect();
            updateModelsUI();

            // Auto-resolve event after some time
            setTimeout(() => {
                if (gameState.isGameOver) return;
                let resolved = false;
                Object.keys(models).forEach(key => {
                    if (models[key].disabled || models[key].cost !== baseModels[key].cost || models[key].latency !== baseModels[key].latency || models[key].quality !== baseModels[key].quality) {
                        resolved = true;
                    }
                    models[key].cost = baseModels[key].cost;
                    models[key].latency = baseModels[key].latency;
                    models[key].quality = baseModels[key].quality;
                    models[key].disabled = false;
                });
                if(resolved) {
                    logNews(`Situation resolved: ${targetProvider} services are back to normal.`, 'info');
                }
                updateModelsUI();
            }, 20000);
        }

        // --- Game Lifecycle & Controls ---
        function toggleApex() {
            gameState.isApexEnabled = !gameState.isApexEnabled;
            if (gameState.isApexEnabled) {
                selectedWorkload = null;
                toggleApexBtn.textContent = 'Disable Apex';
                toggleApexBtn.classList.replace('bg-apex-active-color', 'bg-gray-600');
                toggleApexBtn.classList.remove('bg-apex-active-color');
                apexStatusText.textContent = 'ENABLED';
                apexStatusLight.style.backgroundColor = 'var(--apex-active-color)';
                apexUtilitySelect.disabled = false;
            } else {
                toggleApexBtn.textContent = 'Enable Apex';
                toggleApexBtn.classList.replace('bg-gray-600', 'bg-apex-active-color');
                toggleApexBtn.classList.add('bg-apex-active-color');
                apexStatusText.textContent = 'DISABLED';
                apexStatusLight.style.backgroundColor = '#6b7280';
                apexUtilitySelect.disabled = true;
            }
            updateWorkloadQueueUI();
            updateModelsUI();
        }

        function endGame(isWin) {
            if (gameState.isGameOver) return;
            gameState.isGameOver = true;
            clearInterval(gameLoop);
            clearInterval(workloadInterval);
            clearInterval(newsInterval);
            
            getEl('game-container').classList.add('game-over-fade');
            const finalCost = `$${(gameState.opCost / 1000).toFixed(1)}k`;
            const finalEfficiency = `${Math.round(gameState.tasksCompleted > 0 ? gameState.totalEfficiencyScore / gameState.tasksCompleted : 100)}%`;
            const statsText = `Final Simulated Burn: <b class="text-gray-300">${finalCost}</b> &nbsp;&bull;&nbsp; Final Cost/Perf Index: <b class="text-gray-300">${finalEfficiency}</b>`;
            
            setTimeout(() => {
                const modal = isWin ? getEl('win-modal') : getEl('game-over-modal');
                const statsEl = isWin ? getEl('final-stats-win') : getEl('final-stats-loss');
                statsEl.innerHTML = statsText;
                modal.classList.add('open');
            }, 500);
        }

        function resetGame() {
            if (gameLoop) clearInterval(gameLoop);
            if (workloadInterval) clearInterval(workloadInterval);
            if (newsInterval) clearInterval(newsInterval);

            initializeGame();
            
            if (getEl('apex-status-text').textContent === 'ENABLED') toggleApex();
            apexUtilitySelect.disabled = true;

            getEl('game-container').classList.remove('game-over-fade');
            getEl('game-over-modal').classList.remove('open');
            getEl('win-modal').classList.remove('open');
            
            updateMetricsUI();
            updateWorkloadQueueUI();
            updateModelsUI();
            renderNewsFeed();
            
            gameLoop = setInterval(gameTick, 50);
            workloadInterval = setInterval(generateWorkload, 2500);
            newsInterval = setInterval(triggerNewsEvent, 10000);
        }

        window.onload = () => {
            toggleApexBtn.addEventListener('click', toggleApex);
            ['filter-name', 'filter-provider', 'filter-region', 'sort-by'].forEach(id => {
                getEl(id).addEventListener('input', updateModelsUI);
            });
            sortNewsSelect.addEventListener('change', renderNewsFeed);
            resetGame();
        };
    </script>
</body>
</html>
