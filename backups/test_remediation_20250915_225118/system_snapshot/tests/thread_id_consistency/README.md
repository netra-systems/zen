# Thread ID Consistency Test Suite

## Overview

This test suite reproduces and validates the thread_ID consistency issue causing WebSocket manager resource leaks in the Netra Apex platform. The core problem is that isolation keys containing specific thread_ID values become mismatched during WebSocket manager lifecycle operations, preventing cleanup from finding the correct managers and leading to resource accumulation.

## Business Impact

**Critical System Stability Issue:**
- When users hit the 20 manager limit, new WebSocket connections fail
- System becomes unresponsive for affected users
- Cascading failures affect multiple users in high-traffic scenarios
- Resource exhaustion can lead to complete system outages

## Problem Description

The WebSocket resource leak occurs due to thread_ID inconsistencies at these critical points:

1. **UserExecutionContext Creation** → thread_ID generated by UnifiedIdGenerator
2. **WebSocket Manager Creation** → Uses context's thread_ID in isolation key
3. **Manager Storage** → Factory stores manager with isolation key containing thread_ID  
4. **Cleanup Lookup** → Attempts to find manager using potentially different thread_ID
5. **Resource Leak** → Cleanup fails, manager remains in memory, count accumulates

## Test Architecture

### ThreadIDConsistencyTracker
Central utility that monitors thread_ID values throughout the WebSocket lifecycle:
- **Snapshots:** Captures thread_ID values at each operation
- **Violation Detection:** Identifies thread_ID mismatches automatically
- **Analysis:** Provides consistency score and detailed reports
- **Recovery Testing:** Simulates cleanup scenarios with mismatched IDs

### Test Categories

#### 1. Unit Tests
- `test_thread_id_consistency_user_context_creation`
- Validates UserExecutionContext maintains consistent thread_ID values
- Tests UnifiedIdGenerator vs UnifiedIDManager compatibility
- Should **PASS** - demonstrates proper thread_ID consistency

#### 2. Integration Tests  
- `test_thread_id_inconsistency_websocket_manager_creation`
- **BUG REPRODUCTION:** Simulates thread_ID mismatch between context and manager
- `test_websocket_manager_lifecycle_thread_id_consistency`
- Tests complete WebSocket lifecycle with real authentication
- Uses actual WebSocket components per project requirements

#### 3. E2E Tests
- `test_concurrent_websocket_operations_thread_id_isolation`
- Tests multiple authenticated users concurrently
- Ensures thread_ID isolation between different user sessions
- Validates no cross-contamination between concurrent operations

#### 4. Edge Case Tests
- `test_thread_id_recovery_after_mismatch`
- Tests system recovery when thread_ID mismatches are detected
- Validates force cleanup mechanisms and resource leak prevention

## Expected Test Results

### Bug Reproduction Tests (Should Show Violations)
- `test_thread_id_inconsistency_websocket_manager_creation`
- **Expected:** thread_ID violations detected in analysis
- **Indicates:** Bug successfully reproduced

### Consistency Tests (Should Pass)
- `test_thread_id_consistency_user_context_creation`
- `test_websocket_manager_lifecycle_thread_id_consistency`
- **Expected:** No thread_ID violations, cleanup successful
- **Indicates:** Proper thread_ID consistency maintained

### Recovery Tests (Validates System Resilience)
- `test_thread_id_recovery_after_mismatch`
- **Expected:** Recovery strategies prevent resource leaks
- **Indicates:** System can handle thread_ID mismatches gracefully

## Running the Tests

### Local Environment
```bash
# Run all thread_ID consistency tests
python tests/unified_test_runner.py --category integration --pattern "*thread_id_consistency*"

# Run specific test with detailed logging
pytest tests/thread_id_consistency/test_thread_id_consistency_comprehensive.py::TestThreadIdConsistencyComprehensive::test_thread_id_inconsistency_websocket_manager_creation -v -s

# Run with real services (includes authentication)
python tests/unified_test_runner.py --real-services --category integration --pattern "*thread_id_consistency*"
```

### Staging Environment
```bash
# Run with staging authentication and real WebSocket connections
python tests/unified_test_runner.py --env staging --category e2e --pattern "*thread_id_consistency*"
```

## Test Output Analysis

### ThreadIDConsistencyTracker Report
Each test generates a detailed report showing:
```
=== THREAD_ID CONSISTENCY TRACKING REPORT ===
Tracking Duration: 2.45s
Total Snapshots: 12
Total Violations: 2

SNAPSHOTS:
  [0] user_context_creation @ 1641234567.123s
      user_context: thread_websocket_factory_1234567890_abc_def123
      manager_context: None
      isolation_key: None
      cleanup_lookup: None

  [1] manager_creation @ 1641234567.456s
      user_context: thread_websocket_factory_1234567890_abc_def123
      manager_context: thread_websocket_factory_1234567890_abc_def123
      isolation_key: user123_thread_websocket_factory_1234567890_abc_def123_run456
      cleanup_lookup: None

  [2] inconsistent_context_creation @ 1641234567.789s
      user_context: different-thread-abcd1234
      manager_context: thread_websocket_factory_1234567890_abc_def123
      isolation_key: user123_thread_websocket_factory_1234567890_abc_def123_run456
      cleanup_lookup: None
      ⚠️  MISMATCH DETECTED

VIOLATIONS:
  [0] thread_id_mismatch (CRITICAL)
      Operation: inconsistent_context_creation
      Thread IDs: {'user_context': 'different-thread-abcd1234', 'manager_context': 'thread_websocket_factory_1234567890_abc_def123', 'isolation_key': 'user123_thread_websocket_factory_1234567890_abc_def123_run456', 'cleanup_lookup': 'None'}

ANALYSIS:
  Consistency Score: 83.3%
  Unique Thread IDs: 2
  Thread IDs Found: ['thread_websocket_factory_1234567890_abc_def123', 'different-thread-abcd1234']
```

### Key Metrics to Monitor

1. **Consistency Score:** Should be 100% for healthy tests, <100% indicates violations
2. **Unique Thread IDs:** Should match expected number (1 per user context)
3. **Violations:** Critical violations indicate thread_ID mismatches
4. **Recovery Success:** Force cleanup should resolve mismatched scenarios

## Debugging Thread_ID Issues

### Common Patterns
```python
# Good: Consistent thread_ID throughout lifecycle
user_context.thread_id = "thread_websocket_factory_1234567890_abc_def123"
isolation_key = "user123_thread_websocket_factory_1234567890_abc_def123_run456"
# Cleanup can find manager because thread_ID is embedded in isolation key

# Bad: Thread_ID mismatch prevents cleanup
user_context.thread_id = "different-thread-abcd1234"  
isolation_key = "user123_thread_websocket_factory_1234567890_abc_def123_run456"
# Cleanup fails because lookup thread_ID doesn't match isolation key
```

### Root Cause Analysis Steps

1. **Review ThreadIDConsistencyTracker snapshots** to identify where thread_ID diverges
2. **Check UnifiedIdGenerator vs UnifiedIDManager compatibility** for ID generation consistency  
3. **Validate isolation key construction** to ensure thread_ID is properly embedded
4. **Test cleanup lookup logic** to verify it's using correct thread_ID for finding managers
5. **Monitor resource accumulation** to confirm cleanup failures lead to 20-manager limit

## Project Compliance

### CLAUDE.md Requirements Met
- ✅ **Real Components:** Uses actual WebSocket components, no mocking
- ✅ **E2E Authentication:** All integration/e2e tests use proper JWT authentication
- ✅ **SSOT Test Base:** Inherits from SSotAsyncTestCase
- ✅ **Environment Isolation:** Uses shared.isolated_environment
- ✅ **Error Handling:** Hard failures for all error conditions per project requirements

### Test Framework Integration
- **Base Class:** SSotAsyncTestCase for consistent test foundation
- **Authentication:** E2EAuthHelper with staging support
- **Environment Config:** Automatic detection and configuration
- **Resource Cleanup:** Proper teardown prevents test contamination

## Next Steps

1. **Run tests to reproduce the bug** and analyze ThreadIDConsistencyTracker reports
2. **Identify exact points where thread_ID consistency breaks** using snapshot analysis
3. **Implement fixes** based on root cause analysis findings
4. **Verify fixes** by ensuring consistency tests pass with 100% consistency scores
5. **Add monitoring** to detect thread_ID mismatches in production

This test suite provides the foundation for understanding and fixing the WebSocket resource leak issue by making thread_ID consistency visible and testable.