'''
E2E Test: Cross-Service Authentication Flow

This test validates that authentication flows work correctly across all services
including token generation, validation, and propagation.

Business Value Justification (BVJ):
- Segment: All customer segments (Free, Early, Mid, Enterprise)
- Business Goal: Secure user authentication and authorization
- Value Impact: Ensures users can securely access all platform features
- Strategic/Revenue Impact: Authentication failures block user engagement and conversion
'''

import asyncio
import aiohttp
import pytest
import json
import time
from typing import Dict, Any, Optional
import uuid
import logging

# Import IsolatedEnvironment for proper environment management as required by CLAUDE.md
from shared.isolated_environment import get_env
from test_framework.ssot.e2e_auth_helper import E2EAuthHelper, E2EWebSocketAuthHelper
from test_framework.ssot.base_test_case import SSotBaseTestCase

logger = logging.getLogger(__name__)

async def check_service_availability(session: aiohttp.ClientSession, service_name: str, url: str) -> bool:
    """Check if a service is available by testing its health endpoint."""
    try:
        # First try health endpoint
        health_url = f"{url}/health"
        async with session.get(health_url, timeout=aiohttp.ClientTimeout(total=5)) as response:
            if response.status == 200:
                logger.info(f" PASS:  {service_name} health check passed at {health_url}")
                return True
    except Exception:
        pass

    # If health endpoint fails, try root endpoint
    try:
        async with session.get(url, timeout=aiohttp.ClientTimeout(total=5)) as response:
            if response.status in [200, 404]:  # 404 is acceptable for root endpoint
                logger.info(f" PASS:  {service_name} root endpoint accessible at {url}")
                return True
    except Exception:
        pass

    logger.warning(f" FAIL:  {service_name} not available at {url}")
    return False

@pytest.mark.e2e
@pytest.mark.asyncio
async def test_cross_service_authentication_flow():
    '''
    Test complete authentication flow across all services.
    
    CRITICAL SECURITY TEST: This validates multi-service authentication security.
    Uses REAL authentication without any mocks or bypasses.
    '''

    # Use IsolatedEnvironment for environment management as required by CLAUDE.md
    env = get_env()
    env.set("ENVIRONMENT", "test", "test_cross_service_authentication_flow")
    env.set("NETRA_ENVIRONMENT", "test", "test_cross_service_authentication_flow")
    
    # CRITICAL: Use SSOT E2E Auth Helper - NO MOCKS ALLOWED
    auth_helper = E2EAuthHelper(environment="test")
    websocket_helper = E2EWebSocketAuthHelper(environment="test")
    
    # Use properly running dev services on standard ports
    auth_service_url = "http://localhost:8081"  # Dev auth service on standard port
    backend_service_url = "http://localhost:8000"  # Dev backend service on standard port
    frontend_service_url = "http://localhost:3000"
    
    # Debug: print actual URLs being used
    print(f"[U+1F527] Auth Service URL: {auth_service_url}")
    print(f"[U+1F527] Backend Service URL: {backend_service_url}")
    print(f"[U+1F527] Frontend Service URL: {frontend_service_url}")

                                        # Test user credentials
                                        # REMOVED_SYNTAX_ERROR: test_user = { )
                                        # REMOVED_SYNTAX_ERROR: "email": "formatted_string",
                                        # REMOVED_SYNTAX_ERROR: "password": "TestPassword123!",
                                        # REMOVED_SYNTAX_ERROR: "name": "Test User"
                                        

                                        # REMOVED_SYNTAX_ERROR: authentication_failures = []
                                        # REMOVED_SYNTAX_ERROR: auth_token = None

                                        # REMOVED_SYNTAX_ERROR: async with aiohttp.ClientSession() as session:
                                            # Pre-check: Verify service availability
                                            # REMOVED_SYNTAX_ERROR: print("[SETUP] Checking service availability...")
                                            # REMOVED_SYNTAX_ERROR: services_available = { )
                                            # Removed problematic line: "auth": await check_service_availability(session, "Auth Service", auth_service_url),
                                            # Removed problematic line: "backend": await check_service_availability(session, "Backend Service", backend_service_url)
                                            

                                            # REMOVED_SYNTAX_ERROR: if not services_available["auth"]:
                                                # REMOVED_SYNTAX_ERROR: pytest.skip("formatted_string")

                                                # REMOVED_SYNTAX_ERROR: if not services_available["backend"]:
                                                    # REMOVED_SYNTAX_ERROR: logger.warning("formatted_string")

                                                    # Step 1: User Registration
                                                    # REMOVED_SYNTAX_ERROR: print("[AUTH] Testing user registration...")
                                                    # REMOVED_SYNTAX_ERROR: try:
                                                        # REMOVED_SYNTAX_ERROR: registration_data = { )
                                                        # REMOVED_SYNTAX_ERROR: "email": test_user["email"],
                                                        # REMOVED_SYNTAX_ERROR: "password": test_user["password"],
                                                        # REMOVED_SYNTAX_ERROR: "confirm_password": test_user["password"],
                                                        # REMOVED_SYNTAX_ERROR: "full_name": test_user["name"]
                                                        

                                                        # REMOVED_SYNTAX_ERROR: async with session.post( )
                                                        # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                        # REMOVED_SYNTAX_ERROR: json=registration_data,
                                                        # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=10)
                                                        # REMOVED_SYNTAX_ERROR: ) as response:
                                                            # REMOVED_SYNTAX_ERROR: if response.status != 201:
                                                                # REMOVED_SYNTAX_ERROR: response_text = await response.text()
                                                                # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                # REMOVED_SYNTAX_ERROR: else:
                                                                    # REMOVED_SYNTAX_ERROR: registration_result = await response.json()
                                                                    # REMOVED_SYNTAX_ERROR: print("formatted_string")

                                                                    # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                        # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")

                                                                        # Step 2: User Login
                                                                        # REMOVED_SYNTAX_ERROR: print("[AUTH] Testing user login...")
                                                                        # REMOVED_SYNTAX_ERROR: try:
                                                                            # REMOVED_SYNTAX_ERROR: login_data = { )
                                                                            # REMOVED_SYNTAX_ERROR: "email": test_user["email"],
                                                                            # REMOVED_SYNTAX_ERROR: "password": test_user["password"]
                                                                            

                                                                            # REMOVED_SYNTAX_ERROR: async with session.post( )
                                                                            # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                            # REMOVED_SYNTAX_ERROR: json=login_data,
                                                                            # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=10)
                                                                            # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                # REMOVED_SYNTAX_ERROR: if response.status != 200:
                                                                                    # REMOVED_SYNTAX_ERROR: response_text = await response.text()
                                                                                    # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                    # REMOVED_SYNTAX_ERROR: else:
                                                                                        # REMOVED_SYNTAX_ERROR: login_result = await response.json()
                                                                                        # REMOVED_SYNTAX_ERROR: auth_token = login_result.get("access_token")
                                                                                        # REMOVED_SYNTAX_ERROR: if not auth_token:
                                                                                            # REMOVED_SYNTAX_ERROR: authentication_failures.append("Login response missing access_token")
                                                                                            # REMOVED_SYNTAX_ERROR: else:
                                                                                                # REMOVED_SYNTAX_ERROR: print(f"[SUCCESS] User login successful, token received")

                                                                                                # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                                                    # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")

                                                                                                    # Step 3: Token Validation with Auth Service
                                                                                                    # REMOVED_SYNTAX_ERROR: if auth_token:
                                                                                                        # REMOVED_SYNTAX_ERROR: print("[AUTH] Testing token validation with auth service...")
                                                                                                        # REMOVED_SYNTAX_ERROR: try:
                                                                                                            # REMOVED_SYNTAX_ERROR: headers = {"Authorization": "formatted_string"}
                                                                                                            # REMOVED_SYNTAX_ERROR: async with session.get( )
                                                                                                            # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                            # REMOVED_SYNTAX_ERROR: headers=headers,
                                                                                                            # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=10)
                                                                                                            # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                                                # REMOVED_SYNTAX_ERROR: if response.status != 200:
                                                                                                                    # REMOVED_SYNTAX_ERROR: response_text = await response.text()
                                                                                                                    # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                    # REMOVED_SYNTAX_ERROR: else:
                                                                                                                        # REMOVED_SYNTAX_ERROR: user_info = await response.json()
                                                                                                                        # REMOVED_SYNTAX_ERROR: if user_info.get("email") != test_user["email"]:
                                                                                                                            # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                            # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                # REMOVED_SYNTAX_ERROR: print(f"[SUCCESS] Auth service token validation successful")

                                                                                                                                # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                                                                                    # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")

                                                                                                                                    # Step 4: Cross-Service Token Propagation (Backend)
                                                                                                                                    # REMOVED_SYNTAX_ERROR: if auth_token and services_available["backend"]:
                                                                                                                                        # REMOVED_SYNTAX_ERROR: print("[AUTH] Testing token propagation to backend service...")
                                                                                                                                        # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                            # REMOVED_SYNTAX_ERROR: headers = {"Authorization": "formatted_string"}
                                                                                                                                            # REMOVED_SYNTAX_ERROR: async with session.get( )
                                                                                                                                            # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                            # REMOVED_SYNTAX_ERROR: headers=headers,
                                                                                                                                            # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=10)
                                                                                                                                            # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                                                                                # REMOVED_SYNTAX_ERROR: if response.status != 200:
                                                                                                                                                    # REMOVED_SYNTAX_ERROR: response_text = await response.text()
                                                                                                                                                    # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                                                    # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                        # REMOVED_SYNTAX_ERROR: profile_info = await response.json()
                                                                                                                                                        # REMOVED_SYNTAX_ERROR: print(f"[SUCCESS] Backend service token validation successful")

                                                                                                                                                        # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                                                                                                            # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                                                            # REMOVED_SYNTAX_ERROR: elif auth_token and not services_available["backend"]:
                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("[SKIP] Backend service not available, skipping token propagation test")

                                                                                                                                                                # Step 5: Protected Resource Access
                                                                                                                                                                # REMOVED_SYNTAX_ERROR: if auth_token and services_available["backend"]:
                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: print("[AUTH] Testing protected resource access...")
                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: protected_endpoints = [ )
                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: "formatted_string"
                                                                                                                                                                    

                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: headers = {"Authorization": "formatted_string"}

                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: for endpoint in protected_endpoints:
                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: async with session.get( )
                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: endpoint,
                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: headers=headers,
                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=10)
                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: if response.status == 401:
                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: elif response.status == 404:
                                                                                                                                                                                        # Endpoint might not exist, which is acceptable
                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: pass
                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: elif response.status >= 400:
                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: response_text = await response.text()
                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("formatted_string")

                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: elif auth_token and not services_available["backend"]:
                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: print("[SKIP] Backend service not available, skipping protected resource tests")

                                                                                                                                                                                                        # Step 6: Token Expiry Handling
                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: print("[AUTH] Testing token expiry handling...")
                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: if auth_token:
                                                                                                                                                                                                            # Test with malformed token
                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: malformed_token = auth_token[:-5] + "wrong"
                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: headers = {"Authorization": "formatted_string"}

                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: async with session.get( )
                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: headers=headers,
                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=10)
                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: if response.status != 401:
                                                                                                                                                                                                                        # Removed problematic line: authentication_failures.append("formatted_string")
                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: print("[SUCCESS] Malformed token correctly rejected")

                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")

                                                                                                                                                                                                                                # Step 7: User Logout
                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: if auth_token:
                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: print("[AUTH] Testing user logout...")
                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: headers = {"Authorization": "formatted_string"}
                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: async with session.post( )
                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: headers=headers,
                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=10)
                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: if response.status not in [200, 204]:
                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: response_text = await response.text()
                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: print("[SUCCESS] User logout successful")

                                                                                                                                                                                                                                                    # Verify token is invalidated
                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: await asyncio.sleep(1)  # Brief delay
                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: async with session.get( )
                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: headers=headers,
                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=10)
                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: if response.status != 401:
                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")
                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("[SUCCESS] Token correctly invalidated after logout")

                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: authentication_failures.append("formatted_string")

                                                                                                                                                                                                                                                                    # Step 8: Cross-Origin Authentication (Frontend Integration)
                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: print("[AUTH] Testing cross-origin authentication...")
                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                                                                                                                                                        # Test CORS headers for authentication endpoints
                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: cors_headers = {}
                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: cors_test_successful = False

                                                                                                                                                                                                                                                                        # Try OPTIONS request first (standard CORS preflight)
                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: async with session.options( )
                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: headers={"Origin": "http://localhost:3000"},
                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=5)
                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: cors_headers = dict(response.headers)
                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: cors_test_successful = True
                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("formatted_string")
                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: except Exception as options_error:
                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: print("formatted_string")

                                                                                                                                                                                                                                                                                    # If OPTIONS fails, try a regular GET to check basic CORS headers
                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: async with session.get( )
                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: headers={"Origin": "http://localhost:3000"},
                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=5)
                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: ) as response:
                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: cors_headers = dict(response.headers)
                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: cors_test_successful = True
                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: print("formatted_string")
                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: except Exception as get_error:
                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("formatted_string")

                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: if cors_test_successful:
                                                                                                                                                                                                                                                                                                    # Check for CORS headers (case-insensitive)
                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: cors_headers_lower = {k.lower(): v for k, v in cors_headers.items()}

                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: required_cors_headers = [ )
                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: "access-control-allow-origin",
                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: "access-control-allow-methods",
                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: "access-control-allow-headers"
                                                                                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: missing_cors = []
                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: present_cors = []

                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: for header in required_cors_headers:
                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: if header in cors_headers_lower:
                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: present_cors.append("formatted_string")
                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: missing_cors.append(header)

                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: if missing_cors:
                                                                                                                                                                                                                                                                                                                    # Only report as warning, not failure, since CORS might be configured differently
                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: warning_msg = "formatted_string"
                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: print("formatted_string")
                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: logger.warning(warning_msg)
                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: print("formatted_string")
                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                                                                                                                                            # CORS test completely failed - this might indicate service issues
                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: warning_msg = "CORS test failed completely - service may not be configured for cross-origin requests"
                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: print("formatted_string")
                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: logger.warning(warning_msg)

                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                                                                                                                                                                                                                                                                                # Don't fail the test for CORS issues, just log them
                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: warning_msg = "formatted_string"
                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("formatted_string")
                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: logger.warning(warning_msg)

                                                                                                                                                                                                                                                                                                                                # Cleanup test harness
                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: await harness.cleanup()

                                                                                                                                                                                                                                                                                                                                # Analyze authentication flow results
                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: critical_failures = []
                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: warning_failures = []

                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: for failure in authentication_failures:
                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: if any(critical in failure.lower() for critical in ["registration failed", "login failed", "token validation failed"]):
                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: critical_failures.append(failure)
                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: warning_failures.append(failure)

                                                                                                                                                                                                                                                                                                                                            # Report results
                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: if critical_failures or warning_failures:
                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: failure_report = []

                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: if critical_failures:
                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: failure_report.append("[CRITICAL] Authentication Failures:")
                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: for failure in critical_failures:
                                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: failure_report.append("formatted_string")

                                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: if warning_failures:
                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: failure_report.append("[WARNING] Authentication Issues:")
                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: for failure in warning_failures:
                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: failure_report.append("formatted_string")

                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: failure_report.append("formatted_string")

                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: pytest.fail(f"Cross-service authentication flow failed: )
                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: " + "
                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: ".join(failure_report))

                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("[SUCCESS] Complete cross-service authentication flow working correctly")


                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: @pytest.mark.e2e
                                                                                                                                                                                                                                                                                                                                                                # Removed problematic line: @pytest.mark.asyncio
                                                                                                                                                                                                                                                                                                                                                                # Removed problematic line: async def test_authentication_rate_limiting():
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: '''Test that authentication endpoints have proper rate limiting.

                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: This test will WARN if rate limiting is not implemented but won"t fail the test completely.
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: '''
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: pass
                                                                                                                                                                                                                                                                                                                                                                    # Use IsolatedEnvironment for environment management as required by CLAUDE.md
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: env = get_env()
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: env.set("ENVIRONMENT", "test", "test_authentication_rate_limiting")
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: env.set("NETRA_ENVIRONMENT", "test", "test_authentication_rate_limiting")

                                                                                                                                                                                                                                                                                                                                                                    # Set correct service ports for real running services BEFORE harness initialization
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: import os
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: env.set("TEST_AUTH_PORT", "8082", "test_authentication_rate_limiting")
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: env.set("TEST_BACKEND_PORT", "8002", "test_authentication_rate_limiting")

                                                                                                                                                                                                                                                                                                                                                                    # Initialize test harness for real service integration
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: harness = UnifiedE2ETestHarness()

                                                                                                                                                                                                                                                                                                                                                                    # Use properly running dev service on standard port
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: auth_service_url = "http://localhost:8081"  # Dev auth service on standard port

                                                                                                                                                                                                                                                                                                                                                                    # Test rapid login attempts
                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: rate_limit_warnings = []

                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: async with aiohttp.ClientSession() as session:
                                                                                                                                                                                                                                                                                                                                                                        # First check if auth service is available
                                                                                                                                                                                                                                                                                                                                                                        # Removed problematic line: if not await check_service_availability(session, "Auth Service", auth_service_url):
                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: pytest.skip("formatted_string")

                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: print("[RATE-LIMIT] Testing authentication rate limiting...")

                                                                                                                                                                                                                                                                                                                                                                            # Attempt many rapid login requests
                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: login_data = { )
                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: "email": "nonexistent@example.com",
                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: "password": "wrongpassword"
                                                                                                                                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: start_time = time.time()
                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: responses = []

                                                                                                                                                                                                                                                                                                                                                                            # Make 10 rapid requests (reduced from 20 to be less aggressive)
                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: tasks = []
                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: for i in range(10):
                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: task = session.post( )
                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: "formatted_string",
                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: json=login_data,
                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: timeout=aiohttp.ClientTimeout(total=5)
                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: tasks.append(task)

                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                                                                                                                                                                                                                                                                    # Execute all requests concurrently
                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: async_responses = await asyncio.gather(*tasks, return_exceptions=True)

                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: rate_limited_count = 0
                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: successful_count = 0
                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: error_count = 0

                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: for response in async_responses:
                                                                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: if isinstance(response, Exception):
                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: error_count += 1
                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: continue

                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: try:
                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: if response.status == 429:  # Too Many Requests
                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: rate_limited_count += 1
                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: elif response.status == 401:  # Unauthorized (normal failed login)
                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: successful_count += 1
                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: elif response.status >= 400:
                                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: error_count += 1

                                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: await response.close()
                                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: except Exception:
                                                                                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: error_count += 1

                                                                                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: elapsed_time = time.time() - start_time

                                                                                                                                                                                                                                                                                                                                                                                                        # Analyze results more gracefully
                                                                                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: if rate_limited_count == 0 and successful_count > 5:
                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: rate_limit_warnings.append("formatted_string")

                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: print("formatted_string")

                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: if rate_limited_count > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("formatted_string")

                                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: rate_limit_warnings.append("formatted_string")

                                                                                                                                                                                                                                                                                                                                                                                                                    # Only warn about rate limiting issues, don't fail the test
                                                                                                                                                                                                                                                                                                                                                                                                                    # REMOVED_SYNTAX_ERROR: if rate_limit_warnings:
                                                                                                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: warning_report = ["[RATE-LIMIT] Warnings:"]
                                                                                                                                                                                                                                                                                                                                                                                                                        # REMOVED_SYNTAX_ERROR: for warning in rate_limit_warnings:
                                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: warning_report.append("formatted_string")
                                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: warning_report.append("Note: Rate limiting may not be implemented yet. This is a warning, not a failure.")

                                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: logger.warning(" )
                                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: ".join(warning_report))
                                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: print(" )
                                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: ".join(warning_report))
                                                                                                                                                                                                                                                                                                                                                                                                                            # REMOVED_SYNTAX_ERROR: else:
                                                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: print("[SUCCESS] Authentication rate limiting working correctly")

                                                                                                                                                                                                                                                                                                                                                                                                                                # Cleanup test harness
                                                                                                                                                                                                                                                                                                                                                                                                                                # REMOVED_SYNTAX_ERROR: await harness.cleanup()


if __name__ == "__main__":
    pytest.main([__file__, "-v", "--tb=short"])