# Docker Compose Override for Local Development
# 
# IMPORTANT: This file provides bind mounts for active development where you need
# real-time file synchronization. Only use this when necessary as bind mounts can
# cause Docker Desktop crashes on Windows/macOS.
#
# To use bind mounts for development:
# - docker-compose --profile dev up
#
# To use only named volumes (more stable):
# - mv docker-compose.override.yml docker-compose.override.yml.disabled
# - docker-compose --profile dev up
#
# WARNING: Bind mounts can cause:
# - High CPU/memory usage
# - Docker Desktop crashes
# - Slow file operations
# - File permission issues

version: '3.8'

services:
  # Dev Auth Service - Bind mount override
  dev-auth:
    volumes:
      # Bind mount for live code editing
      # Use delegated for better performance on macOS
      - ./auth_service:/app/auth_service:delegated
      - ./shared:/app/shared:delegated
      - ./logs/auth:/app/logs:delegated
      # Exclude Python cache from bind mount
      - /app/auth_service/__pycache__
      - /app/shared/__pycache__

  # Dev Analytics Service - Bind mount override
  # NOTE: Temporarily disabled - may be causing crashes
  # dev-analytics:
  #   volumes:
  #     - ./analytics_service:/app/analytics_service:delegated
  #     - ./shared:/app/shared:delegated
  #     - ./logs/analytics:/app/logs:delegated
  #     # Exclude Python cache
  #     - /app/analytics_service/__pycache__
  #     - /app/shared/__pycache__

  # Dev Backend Service - Bind mount override
  dev-backend:
    volumes:
      - ./netra_backend:/app/netra_backend:delegated
      - ./shared:/app/shared:delegated
      - ./SPEC:/app/SPEC:delegated
      - ./scripts:/app/scripts:delegated
      - ./logs/backend:/app/logs:delegated
      # Exclude Python cache
      - /app/netra_backend/__pycache__
      - /app/shared/__pycache__
      - /app/scripts/__pycache__

  # Dev Frontend Service - Bind mount override
  dev-frontend:
    volumes:
      # Simplified: Mount the entire frontend directory for better performance
      - ./frontend:/app:delegated
      
      # CRITICAL: Mask the bind mount above using named volumes for build artifacts
      # This prevents these directories from being synced with the host
      - dev_frontend_node_modules:/app/node_modules
      - dev_frontend_next:/app/.next
      - dev_frontend_cache:/app/.cache

# Performance optimization tips:
# 1. Use :delegated on macOS for better write performance
# 2. Use :cached for read-heavy directories
# 3. Exclude build artifacts and dependencies from bind mounts
# 4. Consider using mutagen or docker-sync for better performance
# 5. Regularly prune unused volumes: docker volume prune