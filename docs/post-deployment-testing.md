# Post-Deployment Testing

## Overview

Post-deployment tests automatically verify that authentication and cross-service communication are working correctly after deploying to staging or production environments. These tests help catch configuration issues like JWT secret mismatches that commonly cause authentication failures.

## Features

### Automatic Execution
Post-deployment tests run automatically after successful deployment when using the official deployment script:

```bash
python scripts/deploy_to_gcp.py --project netra-staging --build-local
```

To skip post-deployment tests:
```bash
python scripts/deploy_to_gcp.py --project netra-staging --build-local --skip-post-tests
```

### Manual Execution

#### Command Line
Run tests directly from command line:
```bash
# Test staging environment
python tests/post_deployment/test_auth_integration.py --environment staging

# Test production environment
python tests/post_deployment/test_auth_integration.py --environment production

# Test with custom URLs
python tests/post_deployment/test_auth_integration.py \
    --environment staging \
    --auth-url https://auth.staging.example.com \
    --backend-url https://api.staging.example.com
```

#### Using Test Runner
Run via unified test runner:
```bash
# Run post-deployment tests
python unified_test_runner.py --category post_deployment

# Run with staging environment configuration
TEST_ENV=staging python unified_test_runner.py --category post_deployment
```

## Test Coverage

The post-deployment tests verify:

1. **Service Health**
   - Auth service `/health` endpoint
   - Backend service `/health` endpoint

2. **Token Generation**
   - Auth service can generate valid JWT tokens
   - Tokens have correct structure and claims
   - No typos in token fields (e.g., "acess" vs "access")

3. **Token Validation**
   - Backend can validate tokens from auth service
   - JWT secrets are properly configured
   - Cross-service authentication works

4. **End-to-End Flow**
   - Complete authentication flow between services
   - API endpoints accept authenticated requests

## Common Issues Detected

### JWT Secret Mismatch
The most common issue is when auth service and backend use different JWT_SECRET_KEY values:

**Symptoms:**
- 401 Unauthorized errors on all API requests
- Token generated by auth service rejected by backend
- Error: "Invalid signature" in logs

**Solution:**
Ensure both services have the same JWT_SECRET_KEY environment variable:
1. Check Cloud Run service configurations
2. Update environment variables to use same secret
3. Restart both services
4. Re-run post-deployment tests

### Token Field Typos
Older deployments may generate tokens with typos:

**Symptoms:**
- Token has `"type": "acess"` instead of `"type": "access"`
- Validation fails on token type check

**Solution:**
Deploy latest code which fixes the typo.

## Configuration

### Environment Detection
The test automatically detects the environment based on:
- Command line `--environment` flag
- `TEST_ENV` environment variable
- GCP project ID (in deployment script)

### Service URLs
Default URLs by environment:
- **Development**: http://localhost:8081 (auth), http://localhost:8000 (backend)
- **Staging**: https://auth.staging.netrasystems.ai, https://api.staging.netrasystems.ai
- **Production**: https://auth.netrasystems.ai, https://api.netrasystems.ai

Override with environment variables:
```bash
export AUTH_SERVICE_URL=https://custom-auth.example.com
export BACKEND_URL=https://custom-api.example.com
```

## Test Implementation

The test is located at `tests/post_deployment/test_auth_integration.py` and includes:

- `PostDeploymentAuthTest` class with test methods
- Async test execution using httpx
- JWT token analysis and validation
- Detailed logging for debugging

## Integration with CI/CD

The post-deployment tests can be integrated into CI/CD pipelines:

```yaml
# Example GitHub Actions workflow
- name: Deploy to Staging
  run: python scripts/deploy_to_gcp.py --project netra-staging --build-local

# Post-deployment tests run automatically, but can also be explicit:
- name: Verify Deployment
  run: python tests/post_deployment/test_auth_integration.py --environment staging
```

## Troubleshooting

### Test Failures
If post-deployment tests fail:

1. Check the detailed test output for specific failures
2. Verify service health endpoints are accessible
3. Check JWT_SECRET_KEY configuration in both services
4. Review auth service and backend logs for errors
5. Use the diagnostic script: `python scripts/test_staging_auth.py`

### Network Issues
If tests can't reach services:

1. Verify service URLs are correct
2. Check firewall rules allow access
3. Ensure services are deployed and running
4. Test with curl: `curl https://api.staging.netrasystems.ai/health`

### Token Issues
For token-related problems:

1. Decode the token to check structure
2. Verify issuer and audience claims
3. Check token expiration times
4. Ensure clock synchronization between services