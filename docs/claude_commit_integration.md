# Claude Code Commit Integration

Intelligent git commit message generation using Claude Code CLI with built-in recursion prevention and smart bypass logic.

## Features

### Recursion Prevention
- **Automatic Detection**: Prevents infinite loops when Claude Code itself makes commits
- **Stale Marker Cleanup**: Auto-removes markers older than 5 minutes
- **Process Isolation**: Each commit process is tracked independently

### Smart Bypass Logic
Multiple layers of intelligent bypass:
1. **Environment Detection**: Auto-disabled in CI/CD environments
2. **Pattern Recognition**: Detects bypass keywords in messages
3. **Claude Availability**: Falls back gracefully if Claude CLI unavailable
4. **Existing Messages**: Respects pre-written commit messages

### Bypass Patterns
Messages containing these patterns bypass Claude:
- `BYPASS_CLAUDE`
- `EMERGENCY_FIX`
- `QUICK_FIX`
- `[skip-claude]`
- `[no-claude]`
- `WIP:`
- `TEMP:`
- Messages already generated by Claude

## Installation

### 1. Automatic Setup
```bash
# Check status
python scripts/configure_claude_commit.py status

# Enable the feature
python scripts/configure_claude_commit.py enable

# Install/update hook
python scripts/configure_claude_commit.py install
```

### 2. Manual Setup
```bash
# Make hook executable
chmod +x .git/hooks/prepare-commit-msg

# Enable via git config
git config netra.claude-commit true
```

## Usage

### Normal Workflow
```bash
# Stage your changes
git add .

# Commit - Claude will generate a message
git commit

# The editor opens with Claude's suggestion
# Edit as needed and save
```

### Bypass Methods

#### Method 1: Bypass Keywords
```bash
git commit -m "BYPASS_CLAUDE: Quick documentation fix"
git commit -m "EMERGENCY_FIX: Production hotfix"
```

#### Method 2: Environment Variable
```bash
export DISABLE_CLAUDE_COMMIT=1
git commit -m "Your message"
unset DISABLE_CLAUDE_COMMIT
```

#### Method 3: Git Config
```bash
# Disable globally
git config netra.claude-commit false

# Re-enable
git config netra.claude-commit true
```

## Architecture

### Component Overview
```
┌─────────────────────────────────┐
│     Git Commit Command          │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│   Pre-commit Hooks              │
│   (.pre-commit-config.yaml)     │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  prepare-commit-msg Hook        │
│  (.git/hooks/prepare-commit-msg)│
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  Claude Commit Manager          │
│  (scripts/claude_commit_manager)│
│  ┌──────────────────────┐      │
│  │ Recursion Prevention  │      │
│  │ Bypass Logic         │      │
│  │ Context Generation   │      │
│  └──────────────────────┘      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│     Claude Code CLI             │
│  (Generates commit message)     │
└─────────────────────────────────┘
```

### Key Files

1. **`scripts/claude_commit_manager.py`**
   - Core logic for Claude integration
   - Recursion prevention
   - Bypass pattern detection
   - Context preparation

2. **`scripts/permissive_hooks/claude_commit_hook.py`**
   - Pre-commit integration
   - Configuration checking
   - Activation logic

3. **`.git/hooks/prepare-commit-msg`**
   - Git hook that triggers Claude
   - Message injection
   - Template preservation

4. **`scripts/configure_claude_commit.py`**
   - Configuration utility
   - Status checking
   - Testing capabilities

## State Management

### Recursion Marker
- **Location**: `.git/CLAUDE_COMMIT_IN_PROGRESS`
- **Purpose**: Prevents recursive Claude calls
- **Lifetime**: Auto-removed after completion or 5 minutes

### State File
- **Location**: `.git/claude_commit_state.json`
- **Purpose**: Metrics and debugging
- **Contents**: History of last 100 commits with metadata

### Generated Message Cache
- **Location**: `.git/CLAUDE_COMMIT_MSG`
- **Purpose**: Temporary storage between hooks
- **Lifetime**: Deleted after use

## Configuration

### Git Config Options
```bash
# Enable/disable feature
git config netra.claude-commit true|false

# Check current setting
git config --get netra.claude-commit
```

### Environment Variables
```bash
# Disable for current session
export DISABLE_CLAUDE_COMMIT=1

# Bypass for single commit
CLAUDE_COMMIT_BYPASS=1 git commit

# Re-enable
unset DISABLE_CLAUDE_COMMIT
```

## Testing

### Dry Run Test
```bash
# Test without committing
python scripts/configure_claude_commit.py test
```

### Manual Test
```bash
# Create test file
echo "test" > test.txt
git add test.txt

# Run manager directly
python scripts/claude_commit_manager.py

# Clean up
git reset HEAD test.txt
rm test.txt
```

## Troubleshooting

### Common Issues

1. **Claude CLI Not Found**
   - Install Claude Code: https://claude.ai/code
   - Verify: `which claude` or `where claude`

2. **Hook Not Triggering**
   - Check permissions: `ls -la .git/hooks/prepare-commit-msg`
   - Make executable: `chmod +x .git/hooks/prepare-commit-msg`

3. **Recursion Detection False Positive**
   - Check marker: `ls -la .git/CLAUDE_COMMIT_IN_PROGRESS`
   - Remove if stale: `rm .git/CLAUDE_COMMIT_IN_PROGRESS`

4. **Windows Encoding Issues**
   - Script includes UTF-8 encoding fix for Windows
   - Fallback to ASCII if emojis cause issues

### Debug Mode
```bash
# Enable verbose output
export CLAUDE_COMMIT_DEBUG=1
git commit

# Check state file
cat .git/claude_commit_state.json | python -m json.tool
```

## Best Practices

### When to Use Claude
- ✅ Feature implementations
- ✅ Bug fixes with context
- ✅ Refactoring with business value
- ✅ Complex multi-file changes

### When to Bypass
- ❌ Emergency production fixes
- ❌ Work-in-progress commits
- ❌ Temporary/experimental changes
- ❌ Simple typo fixes

### Commit Message Quality
Claude generates messages following:
1. Conventional commit format (feat:, fix:, etc.)
2. Business value focus
3. Brief summary (50 chars)
4. Detailed body when needed
5. Automatic co-author attribution

## Security Considerations

1. **No Sensitive Data**: Diffs are truncated to prevent leaking large files
2. **Local Processing**: All processing happens locally before sending to Claude
3. **Timeout Protection**: 30-second timeout prevents hanging
4. **Graceful Failures**: Never blocks commits on errors

## Performance

- **Timeout**: 30 seconds maximum
- **Diff Limit**: 10KB to maintain fast processing
- **Caching**: 15-minute cache for repeated operations
- **Parallel Processing**: Hooks run independently

## Future Enhancements

Potential improvements:
- [ ] Custom prompt templates per project
- [ ] Team-specific commit conventions
- [ ] Integration with issue trackers
- [ ] Commit message learning from history
- [ ] Multi-language support
- [ ] Semantic versioning integration