# REMEDIATION PLAN - Issue #1021: WebSocket Event Structure Failures

## Executive Summary
**Root Cause:** Tests expect mock echo behavior but run against real staging services. Tests only receive connection events, not actual agent workflow execution events.

**Solution:** Modify tests to trigger real agent workflows to get proper event structures with all required fields (tool_name, results, etc.).

**Business Impact:** Fixes $500K+ ARR Golden Path validation by ensuring WebSocket events contain proper tool execution data.

## Phase 1: Test Architecture Modification (Priority: P0 - CRITICAL)

### 1.1 Convert Tests to Real Agent Workflow Execution

**Files to Modify:**
- `tests/mission_critical/test_websocket_agent_events_suite.py`
- `tests/staging/test_staging_websocket_agent_events.py`
- `tests/e2e/test_websocket_agent_events_authenticated_e2e.py`

### 1.2 Implementation Steps:

**Replace mock echo behavior with real agent execution:**
```python
# BEFORE: Mock echo behavior
test_message = {"type": "test", "data": "mock_data"}

# AFTER: Real agent execution request
agent_request = {
    "type": "agent_execution",
    "agent_type": "data_helper",  # Use simple, fast agent
    "message": "Generate a brief test response with tool usage",
    "thread_id": str(uuid.uuid4()),
    "user_context": {"user_id": test_user_id}
}
```

**Send requests to actual agent execution endpoints:**
- Use `/api/v1/chat/agents/execute` endpoint instead of direct WebSocket
- Trigger real agent workflows through HTTP API
- WebSocket events will be generated by real agent execution

**Wait for actual agent workflow events:**
```python
# Listen for real agent workflow events
required_events = ["agent_started", "agent_thinking", "tool_executing", "tool_completed", "agent_completed"]
timeout = 30.0  # Increased timeout for real agent execution
```

### 1.3 Event Structure Validation Updates

**Modify validation logic to expect real event structures:**
```python
# Validate tool_executing event structure
def validate_tool_executing_event(event):
    assert event.get("type") == "tool_executing"
    assert "tool_name" in event.get("data", {})
    assert "tool_args" in event.get("data", {})
    assert "correlation_id" in event

# Validate tool_completed event structure  
def validate_tool_completed_event(event):
    assert event.get("type") == "tool_completed"
    assert "tool_name" in event.get("data", {})
    assert "results" in event.get("data", {})
    assert "execution_time" in event.get("data", {})
```

## Phase 2: Infrastructure Modifications (Priority: P1 - HIGH)

### 2.1 Agent Selection for Testing
- Use **DataHelperAgent** for tests (fastest, most reliable)
- Configure agent to use simple tools that generate predictable events
- Ensure agent has access to basic tools like `get_current_time` or `echo_tool`

### 2.2 Test Environment Setup
```python
# Enhanced test setup for real agent workflows
async def setup_real_agent_test():
    """Setup test environment for real agent workflow execution."""
    
    # 1. Initialize real agent execution context
    user_context = UserExecutionContext(user_id=test_user_id)
    
    # 2. Configure agent with minimal tool set
    agent_config = {
        "agent_type": "data_helper",
        "tools": ["get_current_time", "echo_tool"],  # Simple, fast tools
        "max_iterations": 2  # Limit complexity
    }
    
    # 3. Setup WebSocket listener before sending request
    websocket_client = await create_authenticated_websocket_client(
        auth_token=test_token,
        thread_id=test_thread_id
    )
    
    return user_context, agent_config, websocket_client
```

## Phase 3: Backwards Compatibility (Priority: P2 - MEDIUM)

### 3.1 Graceful Degradation
```python
# Add fallback for environments without full agent stack
async def run_websocket_event_test(use_real_agents=True):
    """Run WebSocket tests with real agents when available, fallback otherwise."""
    
    if use_real_agents and staging_agents_available():
        return await run_real_agent_workflow_test()
    else:
        pytest.skip("Real agent stack not available - staging environment required")
```

### 3.2 Test Configuration
- Add environment variable: `WEBSOCKET_TESTS_USE_REAL_AGENTS=true`
- Allow tests to detect staging vs local environments
- Skip tests gracefully when real agent stack unavailable

## Implementation Sequence

1. **Modify Mission Critical Test Suite** (Immediate)
   - File: `tests/mission_critical/test_websocket_agent_events_suite.py`
   - Replace mock behavior with real agent execution
   - Update event structure validation

2. **Update Staging Tests** (Immediate)
   - File: `tests/staging/test_staging_websocket_agent_events.py`
   - Modify to send real agent execution requests
   - Wait for actual workflow events

3. **Update E2E Tests** (Next)
   - File: `tests/e2e/test_websocket_agent_events_authenticated_e2e.py`
   - Integrate with real authentication and agent workflows
   - Validate end-to-end event delivery

4. **Validation Testing** (Final)
   - Run modified tests against staging environment
   - Verify all 5 required events received with correct structure
   - Confirm no regression in other test suites

## Success Criteria
- [ ] All WebSocket events contain required fields (tool_name, results, etc.)
- [ ] Tests trigger real agent workflows instead of mock echo
- [ ] Event structure validation passes for all 5 required events
- [ ] No regression in existing test functionality
- [ ] Tests work reliably in staging environment

## Risk Mitigation
- **Risk:** Increased test execution time due to real agent workflows
  - **Mitigation:** Use fast DataHelperAgent with minimal tool set
- **Risk:** Test flakiness due to real service dependencies
  - **Mitigation:** Implement robust retry logic and timeout handling
- **Risk:** Breaking existing mock-based tests
  - **Mitigation:** Maintain backwards compatibility with environment flags